<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tyre Analysis System - Enterprise Portal</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .hidden { display: none !important; }
        
        /* Enhanced scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #cbd5e1 0%, #94a3b8 100%); border-radius: 10px; border: 2px solid #f1f5f9; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #94a3b8 0%, #64748b 100%); }
        ::-webkit-scrollbar-thumb:active { background: #2563eb; }

        /* Edit icon styles */
        .edit-icon { cursor: pointer; color: #2563eb; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 6px; background: transparent; position: relative; }
        .edit-icon:hover { color: white; background: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3); }
        .edit-icon:active { transform: translateY(0); }

        /* Null value styling */
        .row-null { background: #fff1f2; border-left: 3px solid #ef4444; }
        .row-null:hover { background: #ffe4e6; }
        .cell-null { color: #ef4444; font-weight: 600; font-style: italic; }

        /* Status badges */
        .recipe-status-badge { position: absolute; top: 12px; right: 12px; padding: 4px 12px; font-size: 11px; font-weight: 700; border-radius: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .recipe-status-completed { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .recipe-status-pending { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .status-completed { border-left: 4px solid #10b981; }
        .status-pending { border-left: 4px solid #f59e0b; }

        /* Table styling */
        .parameter-table { font-size: 12px; }
        .parameter-table thead { position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .parameter-table th { padding: 12px 8px; font-weight: 700; background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%); text-transform: uppercase; letter-spacing: 0.8px; font-size: 10px; text-align: center; border-right: 1px solid #e2e8f0; }
        .parameter-table th:first-child { text-align: left; padding-left: 16px; }
        .parameter-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; text-align: center; border-right: 1px solid #f1f5f9; }
        .parameter-table td:first-child { text-align: left; padding-left: 16px; font-weight: 600; color: #334155; }
        .parameter-table tbody tr { transition: all 0.2s ease; }
        .parameter-table tbody tr:hover { background: #f8fafc; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); }

        /* Inline editing */
        .inline-edit-input { width: 100%; padding: 4px; font-size: 12px; text-align: center; border: 1px solid #2563eb; border-radius: 4px; background: white; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        .inline-edit-input:focus { outline: none; border-color: #1d4ed8; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* --- Analytics Dashboard CSS (kept for Data Comparison usage if needed) --- */
        .chart-card { background-color: white; border: 1px solid #d1d5db; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; border-radius: 0.5rem; overflow: hidden; }
        .chart-header { background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; padding: 0.5rem 1rem; text-align: center; font-size: 0.75rem; font-weight: 700; color: #1f2937; text-transform: uppercase; letter-spacing: 0.05em; height: 40px; display: flex; align-items: center; justify-content: center; }
        .chart-body { padding: 0.5rem; flex: 1; position: relative; }
        
        /* BTP Dashboard Styles */
        .btp-stat-box { transition: all 0.2s; }
        .btp-stat-box:hover { transform: translateY(-2px); }

        /* Parameter Analysis Tab Styles */
        .dashboard-section { background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; display: flex; flex-direction: column; overflow: hidden; }
        .section-header { padding: 0.5rem 1rem; border-bottom: 1px solid #f1f5f9; background-color: #f8fafc; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #475569; letter-spacing: 0.05em; }
        .chart-wrapper { flex: 1; position: relative; min-height: 0; padding: 0.5rem; }
    </style>
</head>
<body class="font-sans bg-gray-100">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border-2 border-gray-200">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <i data-lucide="shield-check" class="w-8 h-8 text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">Tyre Analysis System</h1>
                <p class="text-gray-600 mt-2">Enterprise Quality Control Portal</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-700">Role</label>
                    <select id="loginRole" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all">
                        <option value="">Select Role</option>
                        <option value="rpscoe">RPSCoE</option>
                        <option value="btp-quality">BTP Quality</option>
                        <option value="btp-technical">BTP Technical</option>
                    </select>
                </div>
                <button onclick="login()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white p-3 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transform hover:scale-[1.02] transition-all shadow-lg">LOGIN</button>
                <div class="text-center space-y-2 text-sm pt-4">
                    <a href="#" class="text-blue-600 hover:underline block">Forgot Password?</a>
                    <p class="text-gray-600">Contact IT Helpdesk</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-700 to-blue-600 text-white shadow-lg">
            <div class="max-w-[1600px] mx-auto p-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center shadow-md">
                            <i data-lucide="gauge" class="w-7 h-7 text-blue-700"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Tyre Analysis Dashboard</h1>
                            <p class="text-sm text-blue-100">Enterprise Quality Control System</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <p class="text-sm text-blue-100">Logged in as</p>
                            <p class="font-semibold" id="userRoleDisplay">RPSCoE</p>
                        </div>
                        <button onclick="logout()" class="px-4 py-2 bg-blue-800 rounded-lg hover:bg-blue-900 flex items-center gap-2 font-semibold transition-all">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                            LOGOUT
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="bg-white border-b-2 border-gray-200 shadow-sm">
            <div class="max-w-[1600px] mx-auto flex gap-2 p-3 overflow-x-auto">
                <button onclick="switchTab('rpscoe')" id="tab-rpscoe" class="px-6 py-2.5 rounded-lg flex items-center gap-2 bg-blue-600 text-white font-semibold transition-all whitespace-nowrap">
                    <i data-lucide="settings" class="w-4 h-4"></i>
                    RPSCoE Configuration
                </button>
                <button onclick="switchTab('btp')" id="tab-btp" class="px-6 py-2.5 rounded-lg flex items-center gap-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold transition-all whitespace-nowrap">
                    <i data-lucide="clipboard-check" class="w-4 h-4"></i>
                    BTP Quality
                </button>
                <button onclick="switchTab('comparison')" id="tab-comparison" class="px-6 py-2.5 rounded-lg flex items-center gap-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold transition-all whitespace-nowrap">
                    <span>ðŸ“Š</span>
                    Data Comparison
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <main class="max-w-[1600px] mx-auto p-6">
            <!-- RPSCoE Tab -->
            <div id="content-rpscoe" class="space-y-6">
                <!-- Control Bar -->
                <div class="bg-white p-4 rounded-xl border-2 border-gray-200 shadow-sm">
                    <div class="flex justify-between items-center gap-4">
                        <div class="flex items-center gap-3 flex-1">
                            <select id="rpscoeRecipeSelect" onchange="handleRPSCoERecipeChange()" class="p-3 border-2 border-gray-300 rounded-lg text-sm min-w-[250px] focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all font-semibold">
                                <option value="">Select Recipe</option>
                            </select>
                            <select id="rpscoeVersionSelect" disabled class="p-3 border-2 border-gray-300 rounded-lg text-sm min-w-[200px] focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all font-semibold">
                                <option value="">Select Version</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="openComplianceModal()" class="px-4 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold transition-all flex items-center gap-2 shadow-sm">
                                <i data-lucide="target" class="w-4 h-4"></i>
                                Set A + B Compliance Target
                            </button>

                            <div class="relative group">
                                <button onclick="document.getElementById('globalToleranceFile').click()" class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-all flex items-center gap-2 shadow-sm">
                                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                                    Upload Tolerance Sheet
                                </button>
                                <input type="file" id="globalToleranceFile" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleGlobalToleranceUpload(this)">
                            </div>

                            <button onclick="resetRPSCoE()" class="px-6 py-2.5 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-semibold transition-all flex items-center gap-2">
                                <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                Reset
                            </button>
                            <button id="saveTargetSpecsBtn" onclick="saveTargetSpecs()" disabled class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold transition-all shadow-md flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:from-gray-400 disabled:to-gray-500">
                                <i data-lucide="save" class="w-4 h-4"></i>
                                Save Target Specs
                            </button>
                            <button onclick="openLogHistory('rpscoe')" class="px-6 py-2.5 bg-gray-700 text-white rounded-lg hover:bg-gray-800 font-semibold transition-all flex items-center gap-2">
                                <i data-lucide="history" class="w-4 h-4"></i>
                                Log History
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Work Area -->
                <div id="rpscoeWorkArea" class="grid grid-cols-12 gap-6" style="display: none;">
                    <div class="col-span-8 bg-white rounded-xl border-2 border-gray-200 shadow-sm overflow-hidden flex flex-col" style="height: 550px;">
                        <div class="bg-gradient-to-r from-gray-50 to-white p-4 border-b-2 border-gray-200">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <i data-lucide="list-checks" class="w-5 h-5 text-blue-600"></i>
                                Parameters & Target Specifications
                            </h3>
                        </div>
                        <div class="overflow-y-auto flex-1">
                            <table class="w-full parameter-table">
                                <thead>
                                    <tr>
                                        <th class="w-1/3 border-b-2 border-gray-300">Parameter Name</th>
                                        <th class="w-24 border-b-2 border-gray-300">Target Spec</th>
                                        <th class="w-20 border-b-2 border-gray-300 text-blue-800">Tol A (Â±)</th>
                                        <th class="w-20 border-b-2 border-gray-300 text-blue-800">Tol B (Â±)</th>
                                        <th class="w-20 border-b-2 border-gray-300 text-blue-800">Tol C (Â±)</th>
                                        <th class="w-20 border-b-2 border-gray-300 text-blue-800">Tol D (Â±)</th>
                                        <th class="w-16 border-b-2 border-gray-300">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="rpscoeParametersBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-span-4 flex flex-col gap-6">
                        <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm overflow-hidden flex-1" style="height: 340px;">
                            <div class="bg-gradient-to-r from-gray-50 to-white p-4 border-b-2 border-gray-200">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    <i data-lucide="file-image" class="w-5 h-5 text-blue-600"></i>
                                    DWG Design Preview
                                </h3>
                            </div>
                            <div class="p-8 flex items-center justify-center h-full bg-gray-50">
                                <div class="text-center">
                                    <i data-lucide="image" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                    <p class="text-gray-500 font-medium">DWG Preview will appear here</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm p-4 h-full">
                            <h4 class="font-bold text-gray-800 mb-2">Tolerance Info</h4>
                            <p class="text-xs text-gray-500 mb-4">Uploaded sheet: <span class="font-semibold text-indigo-600" id="globalSheetName">None</span></p>
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-xs text-blue-800">
                                <p class="font-bold mb-1">Editing Guide:</p>
                                <ul class="list-disc pl-4 space-y-1">
                                    <li>Click the <i data-lucide="pencil" class="w-3 h-3 inline"></i> icon to edit a row.</li>
                                    <li>Enter values for Target and Tolerances A, B, C, D.</li>
                                    <li>Press Enter or click outside to save.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="rpscoeRecipeList" class="grid grid-cols-3 gap-6">
                    <div class="col-span-2 bg-white p-6 rounded-xl border-2 border-gray-200 shadow-sm">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Select Recipe to Configure</h3>
                        <div id="rpscoeRecipeListContainer" class="grid grid-cols-2 gap-4"></div>
                    </div>
                    <div class="col-span-1 bg-white rounded-xl border-2 border-gray-200 shadow-sm overflow-hidden h-fit">
                        <div class="bg-gradient-to-r from-gray-50 to-white p-4 border-b-2 border-gray-200">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                <i data-lucide="bell" class="w-5 h-5 text-blue-600"></i>
                                Edit Log Notifications
                            </h3>
                        </div>
                        <div class="p-4 space-y-2 overflow-y-auto" style="max-height: 400px;">
                            <div class="flex items-center gap-3 p-3 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
                                <i data-lucide="edit-3" class="w-4 h-4 text-blue-600"></i>
                                <span class="text-sm text-gray-700">10:22 â€“ Tread Width updated</span>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
                                <i data-lucide="package" class="w-4 h-4 text-blue-600"></i>
                                <span class="text-sm text-gray-700">14:45 â€“ Version changed to v1.3</span>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
                                <i data-lucide="refresh-cw" class="w-4 h-4 text-blue-600"></i>
                                <span class="text-sm text-gray-700">11:10 â€“ Specs synced from DWG</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BTP Tab -->
            <div id="content-btp" class="hidden space-y-6">
                <!-- BTP Dashboard View -->
                <div id="btpDashboard" class="space-y-6 animate-fade-in">
                    <!-- Control Bar & Stats -->
                    <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm overflow-hidden">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <div class="flex items-center gap-3">
                                <label class="font-bold text-gray-700">Month â€“ Year :</label>
                                <div class="relative">
                                    <select id="btpMonthSelector" onchange="renderBTPDashboard()" class="appearance-none pl-4 pr-10 py-2 border-2 border-gray-300 rounded-lg font-bold text-gray-800 bg-white hover:border-blue-500 focus:outline-none focus:border-blue-600 transition-colors cursor-pointer">
                                        <option value="2026-02">Feb 2026</option>
                                        <option value="2026-01">Jan 2026</option>
                                        <option value="2025-12">Dec 2025</option>
                                    </select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button id="scheduleUploadBtn" onclick="openScheduleUploadModal()" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold flex items-center gap-2 shadow-sm text-sm">
                                    <i data-lucide="upload" class="w-4 h-4"></i>
                                    Schedule Upload
                                </button>
                                <button onclick="resetBTPDashboard()" class="px-4 py-2 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-semibold flex items-center gap-2 text-sm">
                                    <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                                    Reset
                                </button>
                                <button onclick="openLogHistory('btp')" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 font-semibold flex items-center gap-2 text-sm">
                                    <i data-lucide="history" class="w-4 h-4"></i>
                                    Log History
                                </button>
                            </div>
                        </div>
                        <div class="p-6 flex justify-around items-center bg-white">
                            <div class="text-center btp-stat-box cursor-pointer" onclick="filterBTPRecipes('total')">
                                <p class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-1">Total</p>
                                <p class="text-4xl font-black text-gray-800">6</p>
                            </div>
                            <div class="w-px h-12 bg-gray-200"></div>
                            <div class="text-center btp-stat-box cursor-pointer" onclick="filterBTPRecipes('completed')">
                                <p class="text-sm font-bold text-emerald-600 uppercase tracking-wider mb-1">Completed</p>
                                <p class="text-4xl font-black text-emerald-600">4</p>
                            </div>
                            <div class="w-px h-12 bg-gray-200"></div>
                            <div class="text-center btp-stat-box cursor-pointer" onclick="filterBTPRecipes('pending')">
                                <p class="text-sm font-bold text-yellow-600 uppercase tracking-wider mb-1">Pending</p>
                                <p class="text-4xl font-black text-yellow-600">2</p>
                            </div>
                        </div>
                    </div>

                    <!-- Main Grid Content -->
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <!-- Left Column: Chart & Activity Log -->
                        <div class="lg:col-span-7 space-y-6">
                            <!-- Chart Section -->
                            <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">BTP Quality Status â€“ <span id="btpChartTitleDate">Feb 2026</span></h3>
                                </div>
                                <div class="h-64 relative">
                                    <canvas id="btpStatusChart"></canvas>
                                </div>
                                <p class="text-center text-xs text-gray-500 mt-2 italic">(Bars are clickable to filter list)</p>
                            </div>

                            <!-- Activity Log -->
                            <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm">
                                <div class="p-4 border-b border-gray-200 bg-gray-50">
                                    <h3 class="font-bold text-gray-800">Activity Log â€“ <span id="btpLogDate">Feb 2026</span></h3>
                                </div>
                                <div class="p-4">
                                    <div class="space-y-2 font-mono text-sm">
                                        <div class="flex gap-4 p-2 hover:bg-gray-50 rounded border-b border-gray-100 last:border-0">
                                            <span class="font-bold text-blue-600 min-w-[60px]">10:30</span>
                                            <span class="text-gray-700">Actuals uploaded (Recipe A)</span>
                                        </div>
                                        <div class="flex gap-4 p-2 hover:bg-gray-50 rounded border-b border-gray-100 last:border-0">
                                            <span class="font-bold text-blue-600 min-w-[60px]">11:15</span>
                                            <span class="text-gray-700">Recipe A activated</span>
                                        </div>
                                        <div class="flex gap-4 p-2 hover:bg-gray-50 rounded border-b border-gray-100 last:border-0">
                                            <span class="font-bold text-blue-600 min-w-[60px]">13:05</span>
                                            <span class="text-gray-700">Actuals uploaded (Recipe C)</span>
                                        </div>
                                        <div class="flex gap-4 p-2 hover:bg-gray-50 rounded border-b border-gray-100 last:border-0">
                                            <span class="font-bold text-blue-600 min-w-[60px]">14:10</span>
                                            <span class="text-gray-700">Recipe C activated</span>
                                        </div>
                                        <div class="flex gap-4 p-2 hover:bg-gray-50 rounded border-b border-gray-100 last:border-0">
                                            <span class="font-bold text-blue-600 min-w-[60px]">16:40</span>
                                            <span class="text-gray-700">Schedule updated (Recipe F)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Recipe List -->
                        <div class="lg:col-span-5">
                            <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm flex flex-col h-full" style="min-height: 500px;">
                                <div class="p-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center sticky top-0 z-10">
                                    <h3 class="font-bold text-gray-800">Recipe List â€“ <span id="btpListDate">Feb 2026</span> (<span id="btpListFilter" class="text-blue-600">All</span>)</h3>
                                </div>
                                <div id="btpDashboardList" class="p-4 space-y-3 overflow-y-auto flex-1 max-h-[600px]"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BTP Detail View -->
                <div id="btpDetailView" class="hidden space-y-6">
                    <div class="bg-white p-4 rounded-xl border-2 border-gray-200 shadow-sm flex items-center justify-between">
                         <div class="flex items-center gap-4">
                             <button onclick="backToBTPDashboard()" class="p-2 hover:bg-gray-100 rounded-lg text-gray-600 transition-colors" title="Back to Dashboard">
                                 <i data-lucide="arrow-left" class="w-6 h-6"></i>
                             </button>
                             <div>
                                 <h2 class="text-xl font-bold text-gray-800" id="btpDetailTitle">Recipe Detail</h2>
                                 <p class="text-sm text-gray-500" id="btpDetailSubtitle">Quality measurements and analysis</p>
                             </div>
                         </div>
                         <div class="flex items-center gap-3">
                             <span class="text-sm font-semibold text-gray-600">Version:</span>
                             <select id="btpVersionSelect" class="p-2 border-2 border-gray-300 rounded-lg text-sm font-semibold"></select>
                         </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm overflow-hidden flex flex-col" style="height: 550px;">
                            <div id="btpMasterSheetRoot" class="h-full w-full bg-gray-50"></div>
                        </div>

                        <div class="flex flex-col gap-6">
                            <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm overflow-hidden flex-1" style="height: 340px;">
                                <div class="bg-gradient-to-r from-gray-50 to-white p-4 border-b-2 border-gray-200">
                                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <i data-lucide="clock" class="w-5 h-5 text-yellow-600"></i>
                                        Recipes Pending for Scanning
                                    </h3>
                                </div>
                                <div class="p-4 space-y-2 overflow-y-auto" id="btpPendingScans" style="max-height: 280px;"></div>
                            </div>
                             <div class="bg-white rounded-xl border-2 border-gray-200 shadow-sm overflow-hidden h-fit">
                                <div class="bg-gradient-to-r from-gray-50 to-white p-4 border-b-2 border-gray-200">
                                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <i data-lucide="bell" class="w-5 h-5 text-blue-600"></i>
                                        Recipe Notifications
                                    </h3>
                                </div>
                                <div class="p-4 space-y-2 overflow-y-auto" style="max-height: 400px;">
                                    <div class="flex items-center gap-3 p-3 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
                                        <i data-lucide="upload" class="w-4 h-4 text-blue-600"></i>
                                        <span class="text-sm text-gray-700">10:30 â€“ Actuals uploaded</span>
                                    </div>
                                    <div class="flex items-center gap-3 p-3 bg-blue-50 border-l-4 border-blue-600 rounded-lg">
                                        <i data-lucide="calendar" class="w-4 h-4 text-blue-600"></i>
                                        <span class="text-sm text-gray-700">11:15 â€“ Schedule date updated</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DATA COMPARISON TAB -->
            <div id="content-comparison" class="hidden space-y-6">
                <div id="data-comparison-root"></div>
            </div>

        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white text-center p-4 mt-8">
            <p class="text-sm">Â© 2026 Tyre Analysis System | Enterprise Edition v2.0</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="logHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
            <div class="bg-gradient-to-r from-blue-700 to-blue-600 text-white p-6 flex justify-between items-center">
                <div class="flex items-center gap-3"><i data-lucide="history" class="w-6 h-6"></i><div><h2 class="text-xl font-bold">Edit Log History</h2><p class="text-sm text-blue-100" id="logHistorySubtitle">Recipe Parameter Changes</p></div></div>
                <button onclick="closeLogHistoryModal()" class="text-white hover:bg-blue-800 rounded-full p-2"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 180px);">
                <table class="w-full border-collapse">
                    <thead class="sticky top-0 bg-gray-100 z-10"><tr class="bg-gray-200"><th class="border-2 border-gray-300 p-3 text-left">Recipe Name</th><th class="border-2 border-gray-300 p-3 text-left">Edited By (ID)</th><th class="border-2 border-gray-300 p-3 text-left">Edit Source</th><th class="border-2 border-gray-300 p-3 text-left">Time</th><th class="border-2 border-gray-300 p-3 text-left">Version</th></tr></thead>
                    <tbody id="logHistoryTableBody"></tbody>
                </table>
            </div>
            <div class="bg-gray-100 p-4 flex justify-end border-t-2 border-gray-200"><button onclick="closeLogHistoryModal()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold">Close</button></div>
        </div>
    </div>
    
    <div id="activationModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
            <div class="bg-gradient-to-r from-blue-700 to-blue-600 text-white p-6 rounded-t-xl">
                <h2 class="text-xl font-bold">Activate Target Specifications</h2>
                <p class="text-sm text-blue-100 mt-2">Set the effective date from which these target specifications will be used by the BTP team.</p>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-sm font-semibold mb-2 text-gray-700">ðŸ“… Effective From Date</label>
                    <input type="date" id="effectiveDate" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:ring-2 focus:ring-blue-200">
                    <p class="text-xs text-gray-500 mt-2">By default, today's date is selected. BTP actual entries will follow these specs from the selected date onward.</p>
                </div>
                <div class="bg-yellow-50 border-l-4 border-yellow-600 p-4 rounded-lg mb-6">
                    <p class="text-sm text-yellow-800 flex items-center gap-2">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        Are you sure you want to activate these target specifications? This action will impact all BTP actual measurements from the selected date.
                    </p>
                </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-b-xl flex justify-between items-center border-t-2 border-gray-200">
                <p class="text-xs text-gray-600">You can update the effective date later from the configuration history if required.</p>
                <div class="flex gap-3">
                    <button onclick="cancelActivation()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">Cancel</button>
                    <button onclick="confirmActivation()" class="px-6 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 font-semibold">Confirm & Activate</button>
                </div>
            </div>
        </div>
    </div>

    <div id="complianceModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl transform transition-all">
            <div class="bg-gradient-to-r from-purple-700 to-purple-600 text-white p-6 rounded-t-xl shadow-md">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="target" class="w-6 h-6"></i>
                    Set A + B Compliance Target
                </h2>
                <p class="text-sm text-purple-100 mt-1">Configure monthly compliance goals</p>
            </div>
            <div class="p-6 space-y-6">
                <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <label class="font-bold text-gray-700">Select Year :</label>
                    <select id="compYear" class="p-2 border-2 border-gray-300 rounded-lg font-semibold bg-white text-gray-800 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all outline-none">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4 text-purple-600"></i>
                        Monthly Compliance Targets (%)
                    </label>
                    <div class="grid grid-cols-4 gap-4" id="monthlyInputsContainer">
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Jan</label><input type="number" id="compJan" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Feb</label><input type="number" id="compFeb" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Mar</label><input type="number" id="compMar" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Apr</label><input type="number" id="compApr" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">May</label><input type="number" id="compMay" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Jun</label><input type="number" id="compJun" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Jul</label><input type="number" id="compJul" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Aug</label><input type="number" id="compAug" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Sep</label><input type="number" id="compSep" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Oct</label><input type="number" id="compOct" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Nov</label><input type="number" id="compNov" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                        <div class="flex flex-col"><label class="text-xs font-bold text-gray-500 mb-1">Dec</label><input type="number" id="compDec" oninput="calculateComplianceTotal()" class="p-2 border border-gray-300 rounded text-center font-medium focus:border-purple-500 focus:outline-none transition-colors" placeholder="0"></div>
                    </div>
                </div>
                <hr class="border-gray-200">
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-100 flex justify-between items-center shadow-inner">
                    <span class="font-bold text-gray-800 flex items-center gap-2">
                        Yearly A + B Compliance Target :
                        <span class="text-xs font-normal text-purple-600 bg-white px-2 py-1 rounded-full border border-purple-200">Auto Calculated</span>
                    </span>
                    <div class="text-right">
                        <span class="text-3xl font-black text-purple-700" id="compTotal">0</span>
                        <span class="text-xl font-bold text-purple-500">%</span>
                    </div>
                </div>
                <div>
                    <label class="block font-bold text-gray-700 mb-2">Remarks :</label>
                    <textarea id="compRemarks" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition-all" rows="2" placeholder="Optional text area..."></textarea>
                </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-b-xl flex justify-end gap-3 border-t border-gray-200">
                <button onclick="closeComplianceModal()" class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-semibold transition-colors">Cancel</button>
                <button onclick="saveComplianceTarget()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold shadow-md hover:shadow-lg transition-all flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Save Target
                </button>
            </div>
        </div>
    </div>

    <div id="scheduleUploadModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div id="scheduleUploadContent" class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transition-all">
            <div class="bg-emerald-500 text-white p-5 flex justify-between items-start">
                <div>
                    <h2 class="text-lg font-bold">Schedule Upload</h2>
                    <p class="text-sm text-emerald-50 mt-1">Upload daily production schedule or actuals.</p>
                </div>
                <div class="bg-white/20 p-2 rounded-lg">
                    <i data-lucide="upload" class="w-5 h-5 text-white"></i>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-5">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Select Period</label>
                    <div class="relative">
                        <input type="month" id="uploadMonthSelector" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-emerald-600 focus:ring-2 focus:ring-emerald-200 transition-all outline-none font-medium text-gray-700">
                    </div>
                </div>
                <label class="block text-sm font-semibold text-gray-700 mb-3">Select Schedule File</label>
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-gray-50 hover:border-emerald-400 transition-all group" onclick="document.getElementById('btpExcelFile').click()">
                    <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mb-4 group-hover:bg-white group-hover:shadow-sm transition-all">
                        <i data-lucide="file-spreadsheet" class="w-6 h-6 text-gray-500 group-hover:text-emerald-500"></i>
                    </div>
                    <p class="text-gray-600 font-medium">Drag and drop Excel/CSV file here</p>
                    <p class="text-sm text-gray-400 mt-1">or click to browse</p>
                    <input type="file" id="btpExcelFile" accept=".xlsx,.xls,.csv" class="hidden" onchange="handleFileSelect(this)">
                </div>
                <div id="fileNameDisplay" class="hidden mt-3 p-2 bg-emerald-50 rounded border border-emerald-100 text-sm text-emerald-700 font-medium flex items-center gap-2 animate-fade-in">
                    <i data-lucide="check-circle" class="w-4 h-4"></i>
                    <span id="selectedFileName"></span>
                </div>
                <div class="mt-6 bg-blue-50 border border-blue-100 rounded-lg p-4 flex gap-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-blue-600 flex-shrink-0"></i>
                    <p class="text-xs text-blue-700 leading-relaxed">
                        Ensure the file follows the standard BTP Schedule template (v2.4) to avoid parsing errors.
                    </p>
                </div>
            </div>
            <div class="p-4 bg-gray-50 flex justify-between items-center gap-3">
                <button onclick="closeScheduleUploadModal()" class="px-6 py-2.5 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition-colors flex-1">Cancel</button>
                <button onclick="confirmScheduleUpload()" class="px-6 py-2.5 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2 flex-1 shadow-lg shadow-emerald-200">
                    <i data-lucide="upload" class="w-4 h-4"></i> Upload Schedule
                </button>
            </div>
        </div>
        <div id="scheduleUploadSuccess" class="hidden bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transition-all transform scale-100">
             <div class="bg-emerald-500 text-white p-5 flex justify-between items-start">
                <div>
                    <h2 class="text-lg font-bold">Schedule Upload</h2>
                    <p class="text-sm text-emerald-50 mt-1">Upload daily production schedule or actuals.</p>
                </div>
                <div class="bg-white/20 p-2 rounded-lg">
                    <i data-lucide="upload" class="w-5 h-5 text-white"></i>
                </div>
            </div>
            <div class="p-10 flex flex-col items-center text-center">
                <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mb-6 animate-bounce">
                    <i data-lucide="check" class="w-10 h-10 text-emerald-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Upload Successful!</h3>
                <p class="text-gray-500">The schedule has been processed.</p>
            </div>
        </div>
    </div>

    <script>
        let loggedInRole = null;
        let scheduleBtn = null;
        let btpChartInstance = null;

        const RECIPES_DATA = [
            { id: 'recipe-a', name: 'Recipe A - Standard Compound', description: 'Standard formulation', versions: ['v1.0', 'v1.1', 'v1.2', 'v1.3'], activatedOn: '12-Feb-2026' },
            { id: 'recipe-b', name: 'Recipe B - High Performance', description: 'Enhanced grip and handling', versions: ['v2.0', 'v2.1', 'v2.2'], activatedOn: 'Pending' },
            { id: 'recipe-c', name: 'Recipe C - All Weather', description: 'Optimized for all-season', versions: ['v3.0', 'v3.1', 'v3.2'], activatedOn: '14-Feb-2026' },
            { id: 'recipe-d', name: 'Recipe D - Heavy Duty', description: 'Reinforced compound', versions: ['v1.0', 'v1.1', 'v1.2', 'v1.3', 'v1.4', 'v1.5'], activatedOn: 'Pending' },
            { id: 'recipe-e', name: 'Recipe E - Eco Friendly', description: 'Low rolling resistance', versions: ['v2.0', 'v2.1'], activatedOn: 'Pending' },
            { id: 'recipe-f', name: 'Recipe F - Winter Special', description: 'Cold weather optimized', versions: ['v4.0', 'v4.1', 'v4.2'], activatedOn: '15-Feb-2026' }
        ];

        const PARAMETERS = [
            'Overall Tread Center Gauge', 'Overall Shoulder Gauge SS', 'Overall Shoulder Gauge OSS', 'Tread Center Rubber Gauge', 'Tread shoulder Rubber gauge SS',
            'Tread shoulder Rubber gauge OSS', 'Under Tread 1 at Center', 'Under Tread 2 at Shoulder SS', 'Under Tread 2 at Shoulder OSS', 'Inner Liner gauge at shoulders SS',
            'Inner Liner gauge at shoulders OSS', 'Belt 1 Width', 'Belt 2 Width', 'Belt 1 Centering SS', 'Belt 1 Centering OSS'
        ];

        // --- Parameter Analysis Mock Data Generation ---
        const PA_COMPONENTS = ['Tread', 'Sidewall', 'Belt', 'Capstrip', 'Ply', 'Bead', 'InnerLiner', 'Toe-Toe'];
        const PA_RECIPES = ['145/80R13 ULT XPC1', '155/70R13 TAXIMAX', '165/80R14 TAXIMAX', '185/65R15 UX ROYALE', '195/55R16 UX ROYALE', '205/65R16 UX ROYALE'];
        const PA_COMPONENT_PARAMS = {
            'Tread': ['Tread Center Gauge', 'Tread Shoulder Gauge', 'UT1 Center', 'UT2 Shoulder'],
            'Sidewall': ['Sidewall Gauge Top', 'Sidewall Gauge Mid', 'Sidewall Gauge Bot'],
            'Belt': ['Belt 1 Width', 'Belt 2 Width', 'Belt Angle'],
            'Capstrip': ['Capstrip Width', 'Capstrip Center Gauge'],
            'Ply': ['Ply Width', 'Ply Turnup'],
            'Bead': ['Bead Width', 'Bead Heel Gauge'],
            'InnerLiner': ['IL Gauge Center', 'IL Gauge Shoulder'],
            'Toe-Toe': ['Toe Gauge']
        };
        const generatePAData = () => {
            const data = [];
            const startDate = new Date('2025-01-01');
            const endDate = new Date('2026-12-31'); // Extended range for safety
            
            for (let dt = new Date(startDate); dt <= endDate; dt.setDate(dt.getDate() + 1)) {
                const dateStr = dt.toISOString().split('T')[0];
                const monthStr = dt.toISOString().slice(0, 7);
                PA_RECIPES.forEach(recipe => {
                    if (Math.random() > 0.8) return; 
                    PA_COMPONENTS.forEach(comp => {
                        const params = PA_COMPONENT_PARAMS[comp] || [];
                        params.forEach(param => {
                            for(let s=1; s<=3; s++) {
                                const target = 10 + (params.indexOf(param) * 2); 
                                const tolA = 0.5; const tolB = 0.8; const tolC = 1.2;
                                const actual = target + ((Math.random() - 0.5) * (Math.random() > 0.85 ? 2.5 : 0.8));
                                const diff = Math.abs(actual - target);
                                let grade = 'D';
                                if (diff <= tolA) grade = 'A'; else if (diff <= tolB) grade = 'B'; else if (diff <= tolC) grade = 'C';
                                data.push({
                                    id: Math.random().toString(36).substr(2, 9),
                                    date: dateStr, month: monthStr, recipe, component: comp, parameter: param, section: `S${s}`,
                                    actual, target, tolA, tolB, tolC, grade
                                });
                            }
                        });
                    });
                });
            }
            return data;
        };
        const PA_FULL_DATABASE = generatePAData();

        const BTP_RECIPE_STATUS = {
            'recipe-a': 'completed', 'recipe-b': 'pending', 'recipe-c': 'completed', 'recipe-d': 'pending', 'recipe-e': 'pending', 'recipe-f': 'completed'
        };

        let appState = {
            currentTab: 'rpscoe',
            rpscoe: { selectedRecipe: null, selectedVersion: null, parameterData: [] },
            btp: { selectedRecipe: null, selectedVersion: null, currentFilter: 'total' }
        };

        const COLORS = {
            primary: '#3b82f6', secondary: '#f97316', success: '#22c55e', danger: '#ef4444',
            gray: '#9ca3af', darkBlue: '#1e3a8a', yellow: '#eab308', purple: '#a78bfa',
            teal: '#34d399', sky: '#60a5fa', lightOrange: '#fbbf24', lime: '#a3e635',
            cyan: '#22d3ee', pink: '#f472b6'
        };
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            populateDropdowns();
            renderRecipeCards();
            setDefaultEffectiveDate();
        });

        function populateDropdowns() {
            const rpscoeSelect = document.getElementById('rpscoeRecipeSelect');
            const options = RECIPES_DATA.map(recipe => `<option value="${recipe.id}">${recipe.name}</option>`).join('');
            if (rpscoeSelect) rpscoeSelect.innerHTML = '<option value="">Select Recipe</option>' + options;
        }

        function setDefaultEffectiveDate() {
            const today = new Date().toISOString().split('T')[0];
            const el = document.getElementById('effectiveDate');
            if(el) el.value = today;
        }

        function login() {
            const u = document.getElementById('loginUsername').value;
            const p = document.getElementById('loginPassword').value;
            const r = document.getElementById('loginRole').value;

            if (!u || !p || !r) {
                alert('Please fill in all fields');
                return;
            }

            loggedInRole = r;

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            document.getElementById('userRoleDisplay').textContent =
                r === 'rpscoe' ? 'RPSCoE' :
                r === 'btp-quality' ? 'BTP Quality' :
                'BTP Technical';

            scheduleBtn = document.getElementById('scheduleUploadBtn');
            if (scheduleBtn) scheduleBtn.style.display = 'flex';

            const saveBtn = document.getElementById('saveTargetSpecsBtn');
            if (saveBtn) {
                saveBtn.style.display = 'flex';
                saveBtn.disabled = true; 
            }

            switchTab(loggedInRole === 'btp-quality' ? 'btp' : 'rpscoe');
            lucide.createIcons();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                location.reload();
            }
        }

        function switchTab(tabId) {
            appState.currentTab = tabId;
            document.querySelectorAll('[id^="tab-"]').forEach(btn => btn.className = 'px-6 py-2.5 rounded-lg flex items-center gap-2 bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold transition-all whitespace-nowrap');
            document.getElementById('tab-' + tabId).className = 'px-6 py-2.5 rounded-lg flex items-center gap-2 bg-blue-600 text-white font-semibold transition-all whitespace-nowrap';
            document.querySelectorAll('[id^="content-"]').forEach(content => content.classList.add('hidden'));
            document.getElementById('content-' + tabId).classList.remove('hidden');
            
            if (tabId === 'comparison') mountDataComparison();
            if (tabId === 'btp') {
                renderBTPDashboard();
            }
            lucide.createIcons();
        }

        // --- BTP Functions ---
        function renderBTPDashboard() {
            document.getElementById('btpDashboard').classList.remove('hidden');
            document.getElementById('btpDetailView').classList.add('hidden');
            renderBTPChart();
            filterBTPRecipes('total'); 
            
            const monthVal = document.getElementById('btpMonthSelector').value;
            const [y, m] = monthVal.split('-');
            const dateObj = new Date(y, m-1);
            const displayDate = dateObj.toLocaleString('default', { month: 'short', year: 'numeric' });
            
            document.getElementById('btpChartTitleDate').textContent = displayDate;
            document.getElementById('btpListDate').textContent = displayDate;
            document.getElementById('btpLogDate').textContent = displayDate;
        }
        
        function renderBTPChart() {
             const ctx = document.getElementById('btpStatusChart').getContext('2d');
             if (btpChartInstance) { btpChartInstance.destroy(); }
             btpChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Total', 'Completed', 'Pending'],
                    datasets: [{
                        label: 'Recipes',
                        data: [6, 4, 2],
                        backgroundColor: ['#2563eb', '#10b981', '#ca8a04'],
                        borderWidth: 0,
                        borderRadius: 4,
                        hoverBackgroundColor: ['#1d4ed8', '#059669', '#a16207']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: handleBTPChartClick,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: true, color: '#f3f4f6' } }, x: { grid: { display: false } } }
                }
            });
        }
        
        function handleBTPChartClick(evt, elements) {
            if (elements.length > 0) {
                const index = elements[0].index;
                const filter = ['total', 'completed', 'pending'][index];
                filterBTPRecipes(filter);
            }
        }
        
        function filterBTPRecipes(filter) {
            appState.btp.currentFilter = filter;
            document.getElementById('btpListFilter').textContent = filter.charAt(0).toUpperCase() + filter.slice(1);
            
            const listContainer = document.getElementById('btpDashboardList');
            let filtered = [];
            
            if (filter === 'total') {
                filtered = RECIPES_DATA;
            } else {
                filtered = RECIPES_DATA.filter(r => BTP_RECIPE_STATUS[r.id] === filter);
            }
            
            if (filtered.length === 0) {
                listContainer.innerHTML = `<div class="p-6 text-center text-gray-500 italic">No recipes found for ${filter} filter.</div>`;
            } else {
                listContainer.innerHTML = filtered.map(r => {
                    const status = BTP_RECIPE_STATUS[r.id];
                    const statusText = status === 'completed' ? 'COMPLETED' : 'PENDING';
                    
                    return `
                    <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-400 hover:shadow-md transition-all cursor-pointer relative bg-white group" onclick="viewBTPDetail('${r.id}')">
                         <div class="flex justify-between items-start mb-2">
                             <h4 class="font-bold text-gray-800 group-hover:text-blue-700 transition-colors">${r.name.split(' - ')[0]}</h4>
                             <span class="text-[10px] font-bold px-2 py-1 rounded border ${status === 'completed' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : 'bg-yellow-50 text-yellow-700 border-yellow-200'}">${statusText}</span>
                         </div>
                         <p class="text-xs text-gray-500 mb-3">${r.description}</p>
                         <div class="flex items-center justify-between text-xs text-gray-600 border-t border-gray-100 pt-3">
                             <div><span class="font-semibold text-blue-600">44</span> Parameters</div>
                             <div>Activated: <span class="font-medium">${r.activatedOn}</span></div>
                             <div class="flex items-center gap-1 text-blue-600 font-semibold group-hover:underline">View Details <i data-lucide="arrow-right" class="w-3 h-3"></i></div>
                         </div>
                    </div>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function viewBTPDetail(recipeId) {
            const recipe = RECIPES_DATA.find(r => r.id === recipeId);
            if (!recipe) return;
            appState.btp.selectedRecipe = recipe;
            appState.btp.selectedVersion = recipe.versions[recipe.versions.length - 1];
            document.getElementById('btpDashboard').classList.add('hidden');
            document.getElementById('btpDetailView').classList.remove('hidden');
            document.getElementById('btpDetailTitle').textContent = recipe.name;
            document.getElementById('btpDetailSubtitle').textContent = recipe.description;
            const vSel = document.getElementById('btpVersionSelect');
            vSel.innerHTML = recipe.versions.map((v, i) => `<option value="${v}" ${i===recipe.versions.length-1?'selected':''}>${v}${i===recipe.versions.length-1?' (Latest)':''}</option>`).join('');
            
            if (window.renderMasterSheet) {
                const dateStr = document.getElementById('btpListDate').textContent || 'Feb 2026';
                window.renderMasterSheet('btpMasterSheetRoot', {
                    filterRecipe: recipe.name,
                    filterMonth: dateStr
                });
            }

            renderBTPPendingScans();
            lucide.createIcons();
        }
        
        function backToBTPDashboard() {
            document.getElementById('btpDetailView').classList.add('hidden');
            document.getElementById('btpDashboard').classList.remove('hidden');
            appState.btp.selectedRecipe = null;
        }

        function renderBTPPendingScans() {
             const container = document.getElementById('btpPendingScans');
             const pending = RECIPES_DATA.filter(r => BTP_RECIPE_STATUS[r.id] === 'pending');
             container.innerHTML = pending.length ? pending.map(r => `
                <div class="flex items-center justify-between p-3 bg-yellow-50 border-l-4 border-yellow-600 rounded-lg cursor-pointer hover:bg-yellow-100 transition-colors" onclick="switchRecipeInDetail('${r.id}')">
                    <span class="text-sm font-medium text-gray-800">${r.name.split(' - ')[0]}</span>
                    <span class="px-2 py-0.5 bg-yellow-600 text-white text-[10px] font-bold rounded-full">Pending</span>
                </div>`).join('') : '<div class="text-center py-8 text-gray-500 flex flex-col items-center"><i data-lucide="check-circle" class="w-8 h-8 text-emerald-500 mb-2"></i><span>All recipes completed</span></div>';
             lucide.createIcons();
        }
        
        function switchRecipeInDetail(id) { viewBTPDetail(id); }

        function resetBTPDashboard() {
            filterBTPRecipes('total');
            renderBTPChart(); 
        }

        // --- RPSCoE Functions (Existing) ---
        function renderRecipeCards() {
            const rpscoeContainer = document.getElementById('rpscoeRecipeListContainer');
            if (rpscoeContainer) {
                rpscoeContainer.innerHTML = RECIPES_DATA.map(recipe => `
                    <div class="border-2 border-gray-200 rounded-xl p-6 hover:border-blue-600 hover:shadow-lg transition-all cursor-pointer" onclick="selectRecipeCard('${recipe.id}', 'rpscoe')">
                        <h4 class="font-bold text-lg text-gray-800 mb-2">${recipe.name.split(' - ')[0]}</h4>
                        <p class="text-sm text-gray-600 mb-3">${recipe.description}</p>
                        <div class="flex items-center justify-between"><span class="text-xs text-blue-600 font-semibold">44 Parameters</span><i data-lucide="arrow-right" class="w-4 h-4 text-blue-600"></i></div>
                    </div>`).join('');
            }
            lucide.createIcons();
        }

        function selectRecipeCard(id, tab) {
            const recipe = RECIPES_DATA.find(r => r.id === id);
            if (!recipe) return;
            if (tab === 'rpscoe') {
                appState.rpscoe.selectedRecipe = recipe;
                appState.rpscoe.selectedVersion = recipe.versions[recipe.versions.length - 1];
                appState.rpscoe.parameterData = generateParameterData();
                document.getElementById('rpscoeRecipeSelect').value = id;
                const vSel = document.getElementById('rpscoeVersionSelect');
                vSel.disabled = false;
                vSel.innerHTML = '<option value="">Select Version</option>' + recipe.versions.map((v, i) => `<option value="${v}" ${i===recipe.versions.length-1?'selected':''}>${v}${i===recipe.versions.length-1?' (Latest)':''}</option>`).join('');
                document.getElementById('rpscoeWorkArea').style.display = 'grid';
                document.getElementById('rpscoeRecipeList').style.display = 'none';
                
                const saveBtn = document.getElementById('saveTargetSpecsBtn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.style.display = 'flex';
                }
                
                renderRPSCoEParameters();
            }
            lucide.createIcons();
        }
        
        function handleRPSCoERecipeChange() {
            const id = document.getElementById('rpscoeRecipeSelect').value;
            if(id) selectRecipeCard(id, 'rpscoe');
            else resetRPSCoE();
        }

        function generateParameterData() {
            return PARAMETERS.map((p, i) => ({ 
                name: p, 
                targetSpec: (i % 7 === 0) ? null : `${(Math.random() * 100 + 50).toFixed(2)}`,
                tolA: (i % 7 === 0) ? null : '0.5',
                tolB: (i % 7 === 0) ? null : '0.8',
                tolC: (i % 7 === 0) ? null : '1.0',
                tolD: (i % 7 === 0) ? null : '1.5',
                id: `param_${i}` 
            }));
        }

        function renderRPSCoEParameters() {
            const tbody = document.getElementById('rpscoeParametersBody');
            tbody.innerHTML = appState.rpscoe.parameterData.map(p => {
                const isNull = !p.targetSpec;
                const renderCell = (val, idSuffix) => {
                    return `<td class="border-b border-gray-200 ${isNull?'cell-null':''}" id="${idSuffix}-${p.id}">${isNull?'Null':val}</td>`;
                };
                return `<tr class="${isNull?'row-null':''}">
                    <td class="border-b border-gray-200">${p.name}</td>
                    ${renderCell(p.targetSpec, 'target')}
                    ${renderCell(p.tolA, 'tolA')}
                    ${renderCell(p.tolB, 'tolB')}
                    ${renderCell(p.tolC, 'tolC')}
                    ${renderCell(p.tolD, 'tolD')}
                    <td class="border-b border-gray-200 text-center">
                        <span class="edit-icon inline-flex" onclick="enableInlineEdit('${p.id}')"><i data-lucide="pencil" class="w-4 h-4"></i></span>
                    </td>
                </tr>`;
            }).join('');
            lucide.createIcons();
        }

        function enableInlineEdit(id) {
            const param = appState.rpscoe.parameterData.find(p => p.id === id);
            if (!param) return;
            const createInput = (field, val) => `
                <input type="text" class="inline-edit-input" id="edit-${field}-${id}" value="${val || ''}"
                       onkeypress="if(event.key==='Enter') saveInlineEdit('${id}')">
            `;
            document.getElementById(`target-${id}`).innerHTML = createInput('target', param.targetSpec);
            document.getElementById(`tolA-${id}`).innerHTML = createInput('tolA', param.tolA);
            document.getElementById(`tolB-${id}`).innerHTML = createInput('tolB', param.tolB);
            document.getElementById(`tolC-${id}`).innerHTML = createInput('tolC', param.tolC);
            document.getElementById(`tolD-${id}`).innerHTML = createInput('tolD', param.tolD);
            document.getElementById(`edit-target-${id}`).focus();
        }

        function saveInlineEdit(id) {
            const param = appState.rpscoe.parameterData.find(p => p.id === id);
            if(param) {
                const getVal = (field) => {
                    const el = document.getElementById(`edit-${field}-${id}`);
                    return el ? el.value.trim() : param[field === 'target' ? 'targetSpec' : field];
                };
                param.targetSpec = getVal('target') || null;
                param.tolA = getVal('tolA') || null;
                param.tolB = getVal('tolB') || null;
                param.tolC = getVal('tolC') || null;
                param.tolD = getVal('tolD') || null;
            }
            renderRPSCoEParameters();
        }

        function handleGlobalToleranceUpload(input) {
            if (input.files && input.files.length > 0) {
                const fileName = input.files[0].name;
                const btn = input.previousElementSibling;
                const originalText = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Processing...`;
                lucide.createIcons();

                setTimeout(() => {
                    alert(`Global Tolerance Sheet "${fileName}" uploaded successfully.\n\nTolerances applied to all recipes contextually.`);
                    document.getElementById('globalSheetName').textContent = fileName;
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                    if (appState.rpscoe.selectedRecipe) {
                         appState.rpscoe.parameterData.forEach(p => {
                             if(p.targetSpec) {
                                 p.tolA = "0.6"; p.tolB = "0.9";
                             }
                         });
                         renderRPSCoEParameters();
                    }
                }, 1500);
            }
        }

        function resetRPSCoE() {
            appState.rpscoe = { selectedRecipe: null, selectedVersion: null, parameterData: [] };
            document.getElementById('rpscoeRecipeSelect').value = '';
            document.getElementById('rpscoeVersionSelect').innerHTML = '<option value="">Select Version</option>';
            document.getElementById('rpscoeVersionSelect').disabled = true;
            document.getElementById('rpscoeWorkArea').style.display = 'none';
            document.getElementById('rpscoeRecipeList').style.display = 'grid';
            document.getElementById('saveTargetSpecsBtn').disabled = true;
            document.getElementById('globalSheetName').textContent = "None";
        }

        function saveTargetSpecs() { document.getElementById('activationModal').classList.remove('hidden'); }
        function cancelActivation() { document.getElementById('activationModal').classList.add('hidden'); }
        function confirmActivation() {
            const dateInput = document.getElementById('effectiveDate');
            if(!dateInput.value) { alert('Please select an Effective From Date.'); return; }
            document.getElementById('activationModal').classList.add('hidden');
            const recipeName = appState.rpscoe.selectedRecipe ? appState.rpscoe.selectedRecipe.name : 'Unknown';
            alert(`Target specifications activated successfully!\n\nRecipe: ${recipeName}\nEffective From: ${dateInput.value}`);
        }

        function openComplianceModal() {
            document.getElementById('complianceModal').classList.remove('hidden');
            document.getElementById('compYear').value = new Date().getFullYear();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            months.forEach(m => document.getElementById('comp' + m).value = '');
            calculateComplianceTotal();
        }
        function closeComplianceModal() { document.getElementById('complianceModal').classList.add('hidden'); }
        function calculateComplianceTotal() {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            let total = 0;
            months.forEach(m => { total += parseFloat(document.getElementById('comp' + m).value) || 0; });
            document.getElementById('compTotal').innerText = total; 
        }
        function saveComplianceTarget() {
            const year = document.getElementById('compYear').value;
            const total = document.getElementById('compTotal').innerText;
            alert(`A+B Compliance Target Saved!\n\nYear: ${year}\nTotal Target: ${total}%`);
            closeComplianceModal();
        }
        function openLogHistory(tab) {
            const modal = document.getElementById('logHistoryModal');
            const tbody = document.getElementById('logHistoryTableBody');
            document.getElementById('logHistorySubtitle').textContent = tab === 'rpscoe' ? 'RPSCoE Configuration Changes' : 'BTP Quality Actual Measurements';
            if (tab === 'rpscoe') {
                tbody.innerHTML = `<tr><td class="border-2 p-3">Recipe A - Standard Compound</td><td class="border-2 p-3">USER_12345</td><td class="border-2 p-3"><span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm">Web Portal</span></td><td class="border-2 p-3">2026-01-12 10:22:15</td><td class="border-2 p-3 font-semibold">v1.3</td></tr>`;
            } else {
                tbody.innerHTML = `<tr><td class="border-2 p-3">Recipe A - Standard Compound</td><td class="border-2 p-3">USER_45678</td><td class="border-2 p-3"><span class="bg-green-100 text-green-700 px-2 py-1 rounded-full text-sm">Excel Sheet</span></td><td class="border-2 p-3">2026-01-13 14:30:22</td><td class="border-2 p-3">v1.3</td></tr>`;
            }
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        function closeLogHistoryModal() { document.getElementById('logHistoryModal').classList.add('hidden'); }
        
        function openScheduleUploadModal() { 
            document.getElementById('scheduleUploadModal').classList.remove('hidden');
            document.getElementById('scheduleUploadContent').classList.remove('hidden');
            document.getElementById('scheduleUploadSuccess').classList.add('hidden');
            document.getElementById('btpExcelFile').value = '';
            document.getElementById('selectedFileName').textContent = '';
            document.getElementById('fileNameDisplay').classList.add('hidden');
            const now = new Date();
            const monthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthInput = document.getElementById('uploadMonthSelector');
            if(monthInput) monthInput.value = monthStr;
            lucide.createIcons();
        }
        function closeScheduleUploadModal() { document.getElementById('scheduleUploadModal').classList.add('hidden'); }
        function handleFileSelect(input) {
            if (input.files && input.files.length > 0) {
                document.getElementById('selectedFileName').textContent = input.files[0].name;
                document.getElementById('fileNameDisplay').classList.remove('hidden');
            }
        }
        function confirmScheduleUpload() {
            document.getElementById('scheduleUploadContent').classList.add('hidden');
            document.getElementById('scheduleUploadSuccess').classList.remove('hidden');
            setTimeout(() => { closeScheduleUploadModal(); filterBTPRecipes('total'); }, 2000);
            lucide.createIcons(); 
        }

    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Gauge = (props) => <IconBase {...props}><path d="m12 14 4-4" /><path d="M3.34 19a10 10 1 1 1 17.32 0" /></IconBase>;
        const LogOut = (props) => <IconBase {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></IconBase>;
        const CalendarRange = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" /><path d="M16 2v4" /><path d="M8 2v4" /><path d="M3 10h18" /><path d="M17 14h-6" /><path d="M13 18H7" /></IconBase>;
        const Scissors = (props) => <IconBase {...props}><circle cx="6" cy="6" r="3" /><circle cx="6" cy="18" r="3" /><line x1="20" x2="8.12" y1="4" y2="15.88" /><line x1="14.47" x2="20" y1="14.48" y2="20" /><line x1="8.12" x2="12" y1="8.12" y2="12" /></IconBase>;
        const AlertTriangle = (props) => <IconBase {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><path d="M12 9v4" /><path d="M12 17h.01" /></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></IconBase>;
        const Filter = (props) => <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></IconBase>;
        const Download = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></IconBase>;
        const TableIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><line x1="3" x2="21" y1="9" y2="9" /><line x1="3" x2="21" y1="15" y2="15" /><line x1="12" x2="12" y1="3" y2="21" /></IconBase>;
        const CalendarIcon = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></IconBase>;
        const Printer = (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect width="12" height="8" x="6" y="14" /></IconBase>;
        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

const cutAnalysisData = [
    { id: 1, parameter: "Overall Tread Center Gauge", specTarget: "13.8", tolA: "Â±0.5", tolB: "Â±0.8", tolC: "Â±1.0", s1: "14.59", s2: "14.64", s3: "14.6", avg: "14.61", score: "8.00", rating: "B", status: "OK" },
    { id: 2, parameter: "Overall Shoulder Gauge SS", specTarget: "16.2", tolA: "Â±0.6", tolB: "Â±0.9", tolC: "Â±1.2", s1: "16.88", s2: "17.13", s3: "15.6", avg: "16.54", score: "8.00", rating: "B", status: "OK" },
    { id: 3, parameter: "Overall Shoulder Gauge OSS", specTarget: "15.9", tolA: "Â±0.6", tolB: "Â±0.9", tolC: "Â±1.2", s1: "16.39", s2: "16.6", s3: "16.79", avg: "16.59", score: "8.00", rating: "B", status: "OK" },
    { id: 4, parameter: "* Tread Center Rubber Gauge", specTarget: "9.0", tolA: "Â±0.3", tolB: "Â±0.5", tolC: "Â±0.7", s1: "9.93", s2: "9.86", s3: "9.43", avg: "9.74", score: "8.00", rating: "B", status: "OK" },
    { id: 5, parameter: "* Tread shoulder Rubber gauge SS", specTarget: "8.7", tolA: "Â±0.3", tolB: "Â±0.5", tolC: "Â±0.7", s1: "9.09", s2: "9.21", s3: "8.74", avg: "9.01", score: "9.00", rating: "A", status: "OK" },
    { id: 6, parameter: "* Tread shoulder Rubber gauge OSS", specTarget: "9.1", tolA: "Â±0.3", tolB: "Â±0.5", tolC: "Â±0.7", s1: "9.31", s2: "9.78", s3: "9.25", avg: "9.45", score: "8.00", rating: "B", status: "OK" },
    { id: 7, parameter: "* Under Tread 1 at Center", specTarget: "2.6", tolA: "Â±0.2", tolB: "Â±0.4", tolC: "Â±0.6", s1: "3.09", s2: "2.8", s3: "2.4", avg: "2.76", score: "8.00", rating: "B", status: "OK" },
    { id: 8, parameter: "Under Tread 2 at Shoulder SS", specTarget: "2.4", tolA: "Â±0.2", tolB: "Â±0.4", tolC: "Â±0.6", s1: "2.77", s2: "2.61", s3: "2.52", avg: "2.63", score: "7.00", rating: "C", status: "ACTION!" },
    { id: 9, parameter: "Under Tread 2 at Shoulder OSS", specTarget: "2.5", tolA: "Â±0.2", tolB: "Â±0.4", tolC: "Â±0.6", s1: "2.77", s2: "2.79", s3: "2.45", avg: "2.67", score: "7.00", rating: "C", status: "ACTION!" },
    { id: 10, parameter: "* Inner Liner gauge at shoulders SS", specTarget: "1.8", tolA: "", tolB: "", tolC: "", s1: "", s2: "", s3: "", avg: "#DIV/0!", score: "10.00", rating: "A", status: "OK" },
    { id: 11, parameter: "* Inner Liner gauge at shoulders OSS", specTarget: "1.9", tolA: "", tolB: "", tolC: "", s1: "", s2: "", s3: "", avg: "#DIV/0!", score: "10.00", rating: "A", status: "OK" },
    { id: 12, parameter: "* Belt 1 Width", specTarget: "92", tolA: "Â±1.0", tolB: "Â±1.5", tolC: "Â±2.0", s1: "88.08", s2: "91.22", s3: "87.89", avg: "89.06", score: "9.00", rating: "A", status: "OK" },
    { id: 13, parameter: " * Belt 2 Width", specTarget: "78", tolA: "Â±1.0", tolB: "Â±1.5", tolC: "Â±2.0", s1: "80", s2: "78.6", s3: "81.66", avg: "80.09", score: "9.00", rating: "A", status: "OK" },
    { id: 14, parameter: "Belt 1 Centering SS", specTarget: "44", tolA: "Â±0.8", tolB: "Â±1.2", tolC: "Â±1.6", s1: "46.43", s2: "45.14", s3: "44.9", avg: "45.49", score: "10.00", rating: "A", status: "OK" },
    { id: 15, parameter: "Belt 1 Centering OSS", specTarget: "46", tolA: "Â±0.8", tolB: "Â±1.2", tolC: "Â±1.6", s1: "45.15", s2: "44.4", s3: "42.99", avg: "44.18", score: "10.00", rating: "A", status: "OK" },
    { id: 16, parameter: "Belt 2 Centering SS", specTarget: "41", tolA: "Â±0.8", tolB: "Â±1.2", tolC: "Â±1.6", s1: "40.36", s2: "40.23", s3: "42.25", avg: "40.95", score: "10.00", rating: "A", status: "OK" },
    { id: 17, parameter: "Belt 2 Centering OSS", specTarget: "39", tolA: "Â±0.8", tolB: "Â±1.2", tolC: "Â±1.6", s1: "40.09", s2: "39.88", s3: "39.41", avg: "39.79", score: "10.00", rating: "A", status: "OK" },
    { id: 18, parameter: "Half Width of capstrip SS", specTarget: "49", tolA: "Â±1.0", tolB: "Â±1.5", tolC: "Â±2.0", s1: "47.8", s2: "50.02", s3: "48.94", avg: "48.92", score: "10.00", rating: "A", status: "OK" },
    { id: 19, parameter: "Half Width of capstrip OSS", specTarget: "51", tolA: "Â±1.0", tolB: "Â±1.5", tolC: "Â±2.0", s1: "50.48", s2: "49.55", s3: "48.34", avg: "49.46", score: "10.00", rating: "A", status: "OK" },
    { id: 20, parameter: "Pad Gauge SS", specTarget: "2.8", tolA: "Â±0.2", tolB: "Â±0.4", tolC: "Â±0.6", s1: "3.2", s2: "3.13", s3: "2.99", avg: "3.11", score: "9.00", rating: "A", status: "OK" },
    { id: 21, parameter: "Pad Gauge OSS", specTarget: "2.4", tolA: "Â±0.2", tolB: "Â±0.4", tolC: "Â±0.6", s1: "2.57", s2: "2.36", s3: "2.82", avg: "2.58", score: "10.00", rating: "A", status: "OK" },
];

        const RECIPES_DB = [
            { id: 'r1', name: '120/80R12 ULT XPC1', currentGrades: { A: 15, B: 2, C: 1, D: 0 }, historyGrades: { A: 1200, B: 80, C: 15, D: 5 } },
            { id: 'r2', name: '145/80R13 ULT HL', currentGrades: { A: 20, B: 5, C: 2, D: 1 }, historyGrades: { A: 800, B: 150, C: 40, D: 10 } },
            { id: 'r3', name: '155/70R13 TAXIMAX', currentGrades: { A: 35, B: 1, C: 0, D: 0 }, historyGrades: { A: 2500, B: 50, C: 10, D: 2 } },
            { id: 'r4', name: '165/80R14 UX ROYAL', currentGrades: { A: 10, B: 8, C: 4, D: 1 }, historyGrades: { A: 600, B: 200, C: 80, D: 20 } },
            { id: 'r5', name: '195/80R15 BRUTE', currentGrades: { A: 5, B: 0, C: 0, D: 0 }, historyGrades: { A: 400, B: 10, C: 2, D: 0 } }
        ];

        const PARAMETERS_DB = [
            { id: 1, name: "Overall Tread Center Gauge", date: "Feb-25", target: 13.8, avg: 14.2, std: 0.15, type: "Critical" },
            { id: 2, name: "Overall Shoulder Gauge SS", date: "Jan-25", target: 16.2, avg: 16.8, std: 0.22, type: "Critical" },
            { id: 3, name: "Tread Center Rubber Gauge", date: "Feb-25", target: 9.0, avg: 9.1, std: 0.05, type: "Non-Critical" },
            { id: 4, name: "Under Tread 2 at Shoulder", date: "Dec-24", target: 2.4, avg: 2.9, std: 0.3, type: "Critical" },
            { id: 5, name: "Belt 1 Width", date: "Jan-25", target: 92, avg: 91.5, std: 0.8, type: "Non-Critical" },
            { id: 6, name: "Pad Gauge SS", date: "Feb-25", target: 2.8, avg: 2.9, std: 0.1, type: "Non-Critical" }
        ];

        const CurrentMonthSection = () => {
            const [selectedGrade, setSelectedGrade] = useState('B'); 
            const [currentMonth, setCurrentMonth] = useState('2026-02'); 
            const [sortConfig, setSortConfig] = useState({ key: 'inGrade', direction: 'desc' });
            
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            const aggregates = useMemo(() => {
                const counts = { A: 0, B: 0, C: 0, D: 0 };
                RECIPES_DB.forEach(r => {
                    if (r.currentGrades.A > 0) counts.A++;
                    if (r.currentGrades.B > 0) counts.B++;
                    if (r.currentGrades.C > 0) counts.C++;
                    if (r.currentGrades.D > 0) counts.D++;
                });
                return counts;
            }, [currentMonth]);

            useEffect(() => {
                if (chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const ctx = chartRef.current.getContext('2d');

                    chartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['A', 'B', 'C', 'D'],
                            datasets: [{
                                label: 'Recipes Count',
                                data: [aggregates.A, aggregates.B, aggregates.C, aggregates.D],
                                backgroundColor: ['#22c55e', '#eab308', '#f97316', '#ef4444'],
                                borderRadius: 4,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            onClick: (evt, elements) => {
                                if (elements.length > 0) {
                                    const grades = ['A', 'B', 'C', 'D'];
                                    const newGrade = grades[elements[0].index];
                                    setSelectedGrade(newGrade);
                                    setSortConfig({ key: 'inGrade', direction: 'desc' });
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                title: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true, grid: { display: true, color: '#f1f5f9' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
                return () => {
                    if (chartInstance.current) chartInstance.current.destroy();
                };
            }, [aggregates]);

            const handleSort = (key) => {
                let direction = 'desc';
                if (sortConfig.key === key && sortConfig.direction === 'desc') {
                    direction = 'asc';
                }
                setSortConfig({ key, direction });
            };

            const sortedRecipes = useMemo(() => {
                let data = RECIPES_DB.filter(r => r.currentGrades[selectedGrade] > 0);
                data.sort((a, b) => {
                    let valA = 0;
                    let valB = 0;
                    if (sortConfig.key === 'total') {
                        valA = Object.values(a.currentGrades).reduce((sum, v) => sum + v, 0);
                        valB = Object.values(b.currentGrades).reduce((sum, v) => sum + v, 0);
                    } else if (sortConfig.key === 'inGrade') {
                        valA = a.currentGrades[selectedGrade];
                        valB = b.currentGrades[selectedGrade];
                    }
                    if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                return data;
            }, [selectedGrade, sortConfig, currentMonth]);

            return (
                <div className="flex flex-col h-full bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                    <div className="px-4 py-2 bg-slate-50 border-b border-gray-200 flex justify-between items-center">
                        <h2 className="text-sm font-bold text-slate-800 flex items-center gap-2">
                            <span className="w-2 h-2 rounded-full bg-green-500"></span>
                            Current Month Quality Snapshot
                        </h2>
                        <div className="flex items-center gap-2">
                            <label className="text-[10px] font-bold text-gray-500 uppercase">Month:</label>
                            <input 
                                type="month" 
                                value={currentMonth} 
                                onChange={(e) => setCurrentMonth(e.target.value)}
                                className="text-xs font-semibold text-blue-700 bg-blue-50 border border-blue-200 rounded px-2 py-0.5 focus:outline-none focus:ring-1 focus:ring-blue-500 cursor-pointer"
                            />
                        </div>
                    </div>
                    
                    <div className="flex flex-1 min-h-0">
                        <div className="w-1/3 p-3 border-r border-gray-100 flex flex-col">
                            <h3 className="text-xs font-semibold text-gray-500 mb-2 uppercase tracking-wider">Grade Distribution</h3>
                            <div className="flex-1 relative">
                                <canvas ref={chartRef}></canvas>
                            </div>
                            <p className="text-[10px] text-center text-gray-400 mt-1">Click bars to filter list</p>
                        </div>

                        <div className="w-2/3 flex flex-col">
                            <div className="px-3 py-2 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center">
                                <h3 className="text-xs font-semibold text-gray-600">Affected Recipes</h3>
                                {selectedGrade && <span className={`text-[10px] px-2 py-0.5 rounded text-white font-bold ${selectedGrade === 'A' ? 'bg-green-500' : selectedGrade === 'B' ? 'bg-yellow-500' : selectedGrade === 'C' ? 'bg-orange-500' : 'bg-red-500'}`}>Showing Grade {selectedGrade}</span>}
                            </div>
                            <div className="flex-1 overflow-auto">
                                <table className="w-full text-xs text-left">
                                    <thead className="bg-gray-50 text-gray-500 font-medium sticky top-0 z-10">
                                        <tr>
                                            <th className="px-3 py-2">Recipe</th>
                                            <th className="px-3 py-2 text-center cursor-pointer hover:bg-gray-200 transition-colors select-none" onClick={() => handleSort('total')} title="Sort by Total Checked">
                                                <div className="flex items-center justify-center gap-1">
                                                    Total Checked {sortConfig.key === 'total' && (<span className="text-blue-600">{sortConfig.direction === 'asc' ? 'â†‘' : 'â†“'}</span>)}
                                                </div>
                                            </th>
                                            <th className="px-3 py-2 text-center cursor-pointer hover:bg-gray-200 transition-colors select-none" onClick={() => handleSort('inGrade')} title={`Sort by count In Grade ${selectedGrade}`}>
                                                <div className="flex items-center justify-center gap-1">
                                                    In Grade {selectedGrade} {sortConfig.key === 'inGrade' && (<span className="text-blue-600">{sortConfig.direction === 'asc' ? 'â†‘' : 'â†“'}</span>)}
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {sortedRecipes.map(r => (
                                            <tr key={r.id} className="hover:bg-blue-50/50">
                                                <td className="px-3 py-1.5 font-medium text-slate-700">{r.name}</td>
                                                <td className="px-3 py-1.5 text-center text-slate-500">{Object.values(r.currentGrades).reduce((a, b) => a + b, 0)}</td>
                                                <td className="px-3 py-1.5 text-center font-bold text-slate-800">{r.currentGrades[selectedGrade]}</td>
                                            </tr>
                                        ))}
                                        {sortedRecipes.length === 0 && (
                                            <tr><td colSpan="3" className="text-center py-4 text-gray-400 italic">No recipes found for Grade {selectedGrade}</td></tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const HistoricalSection = () => {
            const [fromDate, setFromDate] = useState('2025-01');
            const [toDate, setToDate] = useState('2025-12');
            const [selectedRecipe, setSelectedRecipe] = useState('');
            const [selectedGrade, setSelectedGrade] = useState(null);
            const [selectedParameter, setSelectedParameter] = useState(null); 
            const [selectedTolerance, setSelectedTolerance] = useState('A'); 

            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const runChartRef = useRef(null);
            const runChartInstance = useRef(null);
            const summaryChartRef = useRef(null);
            const summaryChartInstance = useRef(null);

            useEffect(() => {
                if (selectedParameter) setSelectedTolerance('A');
            }, [selectedParameter]);

            // Grade Chart
            useEffect(() => {
                if (chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const ctx = chartRef.current.getContext('2d');
                    let data = [1200, 150, 40, 10];
                    if (selectedRecipe) {
                         const r = RECIPES_DB.find(x => x.id === selectedRecipe);
                         if (r) data = [r.historyGrades.A, r.historyGrades.B, r.historyGrades.C, r.historyGrades.D];
                    }

                    chartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['A', 'B', 'C', 'D'],
                            datasets: [{
                                label: 'Recipes',
                                data: data,
                                backgroundColor: ['#dcfce7', '#eab308', '#f97316', '#ef4444'],
                                borderColor: ['#22c55e', '#ca8a04', '#ea580c', '#dc2626'],
                                borderWidth: 1,
                                borderRadius: 4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            onClick: (evt, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const grades = ['A', 'B', 'C', 'D'];
                                    const grade = grades[index];
                                    if (grade === 'A') return;
                                    setSelectedGrade(grade);
                                    setSelectedParameter(PARAMETERS_DB[0]);
                                }
                            },
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, grid: { display: true, color: '#f1f5f9' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
                return () => {
                    if (chartInstance.current) chartInstance.current.destroy();
                };
            }, [selectedRecipe]);

            // Run Chart
            useEffect(() => {
                if (runChartRef.current && selectedGrade && selectedRecipe && selectedParameter) {
                    if (runChartInstance.current) runChartInstance.current.destroy();
                    
                    const labels = ['S1 Jan', 'S2 Jan', 'S3 Jan', 'S1 Feb', 'S2 Feb', 'S1 Mar', 'S2 Mar', 'S3 Mar'];
                    const target = selectedParameter.target;
                    
                    let tolBase = 0.3;
                    let tolColor = '#22c55e';
                    
                    if (selectedTolerance === 'B') { tolBase = 0.6; tolColor = '#eab308'; }
                    else if (selectedTolerance === 'C') { tolBase = 0.9; tolColor = '#f97316'; }
                    else if (selectedTolerance === 'D') { tolBase = 1.2; tolColor = '#dc2626'; }

                    const tolVals = labels.map(() => tolBase + (Math.random() * 0.1 - 0.05));
                    const dTarget = labels.map(() => target);
                    const dTolUpper = labels.map((_, i) => target + tolVals[i]);
                    const dTolLower = labels.map((_, i) => target - tolVals[i]);
                    const dActual = labels.map((_, i) => target + (Math.random() * (tolBase * 1.8) - (tolBase * 0.9))); 

                    runChartInstance.current = new Chart(runChartRef.current, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Actual Measured',
                                    data: dActual,
                                    borderColor: '#1e3a8a',
                                    backgroundColor: '#1e3a8a',
                                    pointBackgroundColor: '#1e3a8a',
                                    pointBorderColor: '#fff',
                                    borderWidth: 2,
                                    pointRadius: 4,
                                    pointHoverRadius: 6,
                                    tension: 0.2,
                                    order: 1
                                },
                                {
                                    label: 'Target',
                                    data: dTarget,
                                    borderColor: '#000000',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                    borderDash: [],
                                    fill: false,
                                    order: 2
                                },
                                {
                                    label: `Tol ${selectedTolerance} (+)`,
                                    data: dTolUpper,
                                    borderColor: tolColor,
                                    borderWidth: 1.5,
                                    pointRadius: 0,
                                    borderDash: [5, 3],
                                    fill: false,
                                    order: 3
                                },
                                {
                                    label: `Tol ${selectedTolerance} (-)`,
                                    data: dTolLower,
                                    borderColor: tolColor,
                                    borderWidth: 1.5,
                                    pointRadius: 0,
                                    borderDash: [5, 3],
                                    fill: false,
                                    order: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                title: { display: true, text: `Parameter Trend: ${selectedParameter.name}`, font: { size: 12, weight: 'bold' } },
                                legend: { display: true, position: 'bottom', labels: { usePointStyle: true, boxWidth: 10, font: { size: 10 }, padding: 10 } },
                                tooltip: {
                                    callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`; } }
                                }
                            },
                            scales: {
                                y: { title: { display: true, text: 'Measured Value' }, grid: { color: '#f3f4f6' } },
                                x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                            }
                        }
                    });
                }
                return () => {
                    if (runChartInstance.current) runChartInstance.current.destroy();
                };
            }, [selectedGrade, selectedRecipe, selectedParameter, selectedTolerance]);

            // Summary Chart
            useEffect(() => {
                if (summaryChartRef.current && selectedGrade && selectedRecipe) {
                    if (summaryChartInstance.current) summaryChartInstance.current.destroy();
                    const crit = PARAMETERS_DB.filter(p => p.type === 'Critical').length;
                    const nonCrit = PARAMETERS_DB.filter(p => p.type === 'Non-Critical').length;
                    summaryChartInstance.current = new Chart(summaryChartRef.current, {
                        type: 'bar',
                        data: {
                            labels: ['Critical', 'Non-Critical'],
                            datasets: [{
                                label: 'Count',
                                data: [crit, nonCrit],
                                backgroundColor: ['#ef4444', '#3b82f6'],
                                borderRadius: 4,
                                barThickness: 25
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: true, grid: {display: false} },
                                y: { grid: { display: false } }
                            }
                        }
                    });
                }
                return () => {
                    if (summaryChartInstance.current) summaryChartInstance.current.destroy();
                };
            }, [selectedGrade, selectedRecipe]);

            return (
                <div className="flex flex-col h-full bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                    <div className="px-4 py-2 bg-slate-50 border-b border-gray-200 flex justify-between items-center shrink-0">
                        <h2 className="text-sm font-bold text-slate-800 flex items-center gap-2">
                            <span className="w-2 h-2 rounded-full bg-purple-500"></span>
                            Historical Investigation
                        </h2>
                        <div className="flex items-center gap-2">
                            <span className="text-[10px] uppercase font-bold text-gray-400">Timeline:</span>
                            <input type="month" value={fromDate} onChange={e => setFromDate(e.target.value)} className="text-xs border rounded px-1 py-0.5 bg-white text-gray-700 focus:ring-1 focus:ring-purple-500" />
                            <span className="text-gray-400">-</span>
                            <input type="month" value={toDate} onChange={e => setToDate(e.target.value)} className="text-xs border rounded px-1 py-0.5 bg-white text-gray-700 focus:ring-1 focus:ring-purple-500" />
                        </div>
                    </div>

                    <div className="flex flex-1 min-h-0">
                        <div className="w-1/4 p-3 border-r border-gray-100 flex flex-col bg-gray-50/30">
                            <div className="flex items-center justify-between mb-2">
                                <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Grade Trends</h3>
                                {selectedGrade && <button onClick={() => {setSelectedGrade(null); setSelectedParameter(null);}} className="text-[10px] text-blue-600 hover:underline">Clear Grade</button>}
                            </div>
                            <div className="flex-1 relative">
                                <canvas ref={chartRef}></canvas>
                            </div>
                            <div className="mt-2 p-2 bg-yellow-50 border border-yellow-100 rounded text-[10px] text-yellow-800 leading-tight">
                                <strong>Note:</strong> Select a Recipe first, then click Grade B, C, or D bars to investigate. Grade A is read-only.
                            </div>
                        </div>

                        <div className="w-3/4 flex flex-col">
                            <div className="p-3 border-b border-gray-100 flex items-center gap-3 bg-white shrink-0">
                                <label className="text-xs font-bold text-gray-700 uppercase tracking-wide">Select Recipe:</label>
                                <select 
                                    className="flex-1 text-sm border-gray-300 rounded-md border shadow-sm py-1 px-2 focus:border-purple-500 focus:ring-1 focus:ring-purple-500 outline-none"
                                    value={selectedRecipe}
                                    onChange={(e) => { setSelectedRecipe(e.target.value); setSelectedGrade(null); setSelectedParameter(null); }}
                                >
                                    <option value="">-- Choose Recipe for Root Cause Analysis --</option>
                                    {RECIPES_DB.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                </select>
                            </div>

                            {!selectedRecipe ? (
                                <div className="flex-1 flex flex-col items-center justify-center text-gray-300">
                                    <Icon path={<path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />} className="w-12 h-12 mb-2 opacity-20" />
                                    <p className="text-sm font-medium">Please select a recipe to begin investigation</p>
                                </div>
                            ) : !selectedGrade ? (
                                <div className="flex-1 flex flex-col items-center justify-center text-gray-300 bg-gray-50/30">
                                    <Icon path={<path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />} className="w-12 h-12 mb-2 opacity-20" />
                                    <p className="text-sm font-medium">Click on Grade B, C, or D bar in the left chart</p>
                                </div>
                            ) : (
                                <div className="flex flex-col flex-1 min-h-0 overflow-hidden">
                                    <div className="flex-1 flex flex-row min-h-0 border-b border-gray-200">
                                        <div className="w-1/2 flex flex-col border-r border-gray-100">
                                            <div className="px-3 py-2 bg-gray-50 border-b border-gray-100 font-bold text-xs text-gray-700 flex justify-between shrink-0">
                                                <span>Parameter Contribution (Grade {selectedGrade})</span>
                                                <span className="text-[10px] font-normal text-gray-500">Click row to view trend</span>
                                            </div>
                                            <div className="flex-1 overflow-auto">
                                                <table className="w-full text-xs text-left">
                                                    <thead className="bg-white text-gray-500 sticky top-0 shadow-sm z-10">
                                                        <tr>
                                                            <th className="px-3 py-2 border-b">Parameter</th>
                                                            <th className="px-2 py-2 border-b text-center">MM-YY</th>
                                                            <th className="px-2 py-2 border-b text-center">Tgt</th>
                                                            <th className="px-2 py-2 border-b text-center">Avg</th>
                                                            <th className="px-2 py-2 border-b text-center">Std</th>
                                                            <th className="px-2 py-2 border-b text-center">Dev</th>
                                                            <th className="px-2 py-2 border-b text-center">Type</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-50">
                                                        {PARAMETERS_DB.map(p => (
                                                            <tr key={p.id} onClick={() => setSelectedParameter(p)} className={`cursor-pointer transition-colors ${selectedParameter?.id === p.id ? 'bg-purple-50' : 'hover:bg-gray-50'}`}>
                                                                <td className="px-3 py-1.5 font-medium text-slate-700 truncate max-w-[120px]" title={p.name}>{p.name}</td>
                                                                <td className="px-2 py-1.5 text-center text-slate-500 text-[10px] whitespace-nowrap">{p.date}</td>
                                                                <td className="px-2 py-1.5 text-center text-gray-500">{p.target}</td>
                                                                <td className="px-2 py-1.5 text-center font-mono text-slate-600">{p.avg}</td>
                                                                <td className="px-2 py-1.5 text-center font-mono text-slate-500">{p.std}</td>
                                                                <td className={`px-2 py-1.5 text-center font-bold ${Math.abs(p.avg - p.target) > 0.5 ? 'text-red-500' : 'text-green-600'}`}>{(p.avg - p.target).toFixed(1)}</td>
                                                                <td className="px-2 py-1.5 text-center">
                                                                    <span className={`text-[9px] px-1.5 py-0.5 rounded border ${p.type === 'Critical' ? 'bg-red-50 text-red-600 border-red-100' : 'bg-blue-50 text-blue-600 border-blue-100'}`}>{p.type === 'Critical' ? 'CRIT' : 'NON'}</span>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        <div className="w-1/2 p-2 flex flex-col bg-slate-50/50">
                                             <div className="flex justify-between items-center mb-1 px-1">
                                                <span className="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-1">
                                                    <Icon path={<path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />} className="w-3 h-3" />
                                                    Trend Analysis
                                                </span>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-[10px] text-gray-600 font-medium">Tolerance:</span>
                                                    <div className="flex bg-white border border-gray-300 rounded overflow-hidden shadow-sm">
                                                        {['A', 'B', 'C', 'D'].map(t => (
                                                            <button key={t} onClick={() => setSelectedTolerance(t)} className={`text-[9px] px-2 py-0.5 font-bold transition-colors border-r last:border-r-0 border-gray-100 ${selectedTolerance === t ? 'bg-blue-600 text-white' : 'text-gray-500 hover:bg-gray-50'}`}>{t}</button>
                                                        ))}
                                                    </div>
                                                </div>
                                             </div>
                                             <div className="flex-1 relative bg-white rounded border border-gray-200 shadow-sm p-1">
                                                 <canvas ref={runChartRef}></canvas>
                                             </div>
                                             <div className="mt-1 flex justify-end">
                                                  <button className="text-[10px] bg-white border border-gray-300 text-gray-700 px-2 py-0.5 rounded hover:bg-gray-50 shadow-sm">Full Report</button>
                                             </div>
                                        </div>
                                    </div>

                                    <div className="h-28 p-3 bg-gray-50 border-t border-gray-200 flex flex-col justify-center shrink-0">
                                         <h4 className="text-[10px] font-bold text-gray-500 uppercase mb-1 flex items-center gap-2">
                                            <Icon path={<path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />} className="w-3 h-3" />
                                            Impact Summary (Critical vs Non-Critical)
                                         </h4>
                                         <div className="flex-1 relative w-full">
                                             <canvas ref={summaryChartRef}></canvas>
                                         </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const CutAnalysis = ({ filterRecipe, filterMonth, filterGrade, highlightParam }) => (
            <div className="flex flex-col h-full">
                <div className="flex justify-between items-center mb-4 px-1">
                     <div className="flex items-center gap-3">
                        <div className="flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-300 rounded-lg shadow-sm">
                            <CalendarIcon className="w-4 h-4 text-blue-600" />
                            <span className="text-sm font-semibold text-gray-700">{filterMonth || 'September 2025'}</span>
                        </div>
                        <div className="h-6 w-px bg-gray-300 mx-1"></div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-medium text-gray-500 uppercase tracking-wide">Recipe:</span>
                            <div className="pl-2 pr-4 py-1.5 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-800 shadow-sm min-w-[280px]">
                                {filterRecipe ? filterRecipe.split(' - ')[0] : '120/80R12 ULT XPC1 74F TL'}
                            </div>
                        </div>
                     </div>
                     <div className="flex gap-2">
                        <button className="px-3 py-1.5 bg-white border border-gray-300 text-gray-700 rounded-lg text-xs font-medium hover:bg-gray-50 flex items-center gap-1 shadow-sm transition-colors">
                            <Printer className="w-3.5 h-3.5" /> Print
                        </button>
                        <button className="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 flex items-center gap-1 shadow-sm transition-colors">
                            <Download className="w-3.5 h-3.5" /> PDF
                        </button>
                     </div>
                </div>
                <div className="flex-1 overflow-auto bg-gray-100/50 rounded-lg border border-gray-200 p-4">
                    <div className="min-w-[1000px] max-w-[1200px] mx-auto bg-white shadow-lg border border-gray-300 text-[10px] leading-tight font-sans">
                        <div className="bg-blue-900 text-white p-1 text-center font-bold text-lg border-b border-white">
                            <div className="flex justify-between items-center px-4">
                                <span className="italic text-yellow-400 font-black text-xl tracking-tighter">JKTYRE</span>
                                <span>PCR - SECTION ANALYSIS REPORT</span>
                                <div className="text-[9px] text-right leading-3 font-normal">
                                    <div>Format No: CORP/TECH/P/J001</div>
                                    <div>Date: {filterMonth ? new Date().toLocaleDateString() : '17-09-2025'}</div>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-12 border-b-2 border-black text-black">
                            <div className="col-span-3 border-r border-gray-400">
                                {[
                                    { label: 'TYRE SIZE :', value: filterRecipe ? filterRecipe.split(' - ')[0] : '120/80R12 ULT XPC1 74F TL', bold: true },
                                    { label: 'Tyre Code:', value: '120/80R12' },
                                    { label: 'Construction:', value: '' },
                                    { label: 'Location Plant:', value: 'BTP', bold: true },
                                    { label: 'Load Index:', value: '74', bold: true },
                                    { label: 'Speed Rating:', value: 'F', bold: true },
                                    { label: 'OE/REP:', value: 'OE', bold: true },
                                ].map((item, idx) => (
                                    <div key={idx} className="grid grid-cols-3 border-b border-gray-300 last:border-0">
                                        <div className="bg-blue-700 text-white p-1 font-semibold col-span-1">{item.label}</div>
                                        <div className={`col-span-2 p-1 text-center ${item.bold ? 'font-bold' : ''}`}>{item.value}</div>
                                    </div>
                                ))}
                            </div>

                            <div className="col-span-4 border-r border-gray-400">
                                <div className="grid grid-cols-4 border-b border-gray-300"><div className="bg-blue-700 text-white p-1 font-semibold col-span-1">Pattern:</div><div className="col-span-2 p-1 font-bold text-center border-r border-gray-300">ULT XPC1</div><div className="col-span-1 text-center font-bold bg-white flex items-center justify-center">TBM</div></div>
                                <div className="grid grid-cols-4 border-b border-gray-300"><div className="bg-blue-700 text-white p-1 font-semibold col-span-1">Mfg.spec No.</div><div className="col-span-2 p-1 text-center border-r border-gray-300"></div><div className="col-span-1 text-center font-bold bg-white row-span-2 flex items-center justify-center">IRM</div></div>
                                <div className="grid grid-cols-4 border-b border-gray-300"><div className="bg-blue-700 text-white p-1 font-semibold col-span-1">Design No :</div><div className="col-span-2 p-1 text-center border-r border-gray-300"></div></div>
                                <div className="grid grid-cols-4 border-b border-gray-300"><div className="bg-blue-700 text-white p-1 font-semibold col-span-1">Tread ID:</div><div className="col-span-3 p-1 text-center font-bold">1R</div></div>

                                <div className="grid grid-cols-5 bg-blue-800 text-white text-center border-b border-gray-300">
                                    <div className="col-span-1 p-0.5 border-r border-blue-600">Category</div>
                                    <div className="col-span-1 p-0.5 border-r border-blue-600">A</div>
                                    <div className="col-span-1 p-0.5 border-r border-blue-600">B</div>
                                    <div className="col-span-1 p-0.5 border-r border-blue-600">C</div>
                                    <div className="col-span-1 p-0.5">D</div>
                                </div>
                                <div className="grid grid-cols-5 text-center bg-blue-600 text-white border-b border-gray-300">
                                    <div className="col-span-1 p-0.5 border-r border-blue-500 text-[9px]">Critical Parameter</div>
                                    <div className="col-span-1 p-0.5 border-r border-blue-500">15</div>
                                    <div className="col-span-1 p-0.5 border-r border-blue-500">4</div>
                                    <div className="col-span-1 p-0.5 border-r border-blue-500">0</div>
                                    <div className="col-span-1 p-0.5">0</div>
                                </div>
                                <div className="grid grid-cols-5 text-center bg-blue-600 text-white">
                                    <div className="col-span-1 p-0.5 border-r border-blue-500 text-[9px]">Non-Critical Para.</div>
                                    <div className="col-span-1 p-0.5 border-r border-blue-500">13</div>
                                    <div className="col-span-1 p-0.5 border-r border-blue-500">5</div>
                                    <div className="col-span-1 p-0.5 border-r border-blue-500">2</div>
                                    <div className="col-span-1 p-0.5">0</div>
                                </div>
                            </div>

                            <div className="col-span-5">
                                <div className="grid grid-cols-12 h-full">
                                    <div className="col-span-6 border-r border-gray-400">
                                        <div className="grid grid-cols-2 border-b border-gray-300"><div className="bg-blue-700 text-white p-1 font-semibold">Mould No :</div><div className="p-1 text-center">GC-02</div></div>
                                        <div className="grid grid-cols-2 border-b border-gray-300"><div className="bg-blue-700 text-white p-1 font-semibold">Tyre weight:</div><div className="p-1 text-center">14.77</div></div>
                                        <div className="grid grid-cols-2 border-b border-gray-300"><div className="bg-blue-700 text-white p-1 font-semibold">Barcode :</div><div className="p-1 text-center">1046891088</div></div>
                                        <div className="grid grid-cols-2 border-b border-gray-300"><div className="bg-blue-700 text-white p-1 font-semibold">Week code:</div><div className="p-1 text-center">4825</div></div>
                                    </div>
                            <div className="col-span-3 bg-[#92d050] border-r border-gray-400 flex flex-col items-center justify-center">
                                <div className="text-white font-bold bg-purple-700 w-full text-center py-0.5 mb-1">
                                    TYRE GRADE
                                </div>

                                <div className="text-5xl font-black text-black leading-none">{filterGrade || 'B'}</div>

                                <div className="mt-1 text-lg font-bold text-black">
                                    GOOD
                                </div>
                            </div>

                                    <div className="col-span-3 bg-[#00b050] flex flex-col items-center justify-center">
                                        <div className="text-white font-bold bg-purple-700 w-full text-center py-0.5 mb-1">TYRE RATING</div>
                                        <div className="text-xl font-bold text-black">91.19%</div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <table className="w-full border-collapse border border-gray-400">
                            <thead>
                                <tr className="bg-blue-900 text-white text-center">
                                    <th className="border border-gray-400 py-1 w-8">Sr No</th>
                                    <th className="border border-gray-400 py-1 text-left px-2">Parameters</th>
                                    <th className="border border-gray-400 py-1 w-12 bg-yellow-600/50 text-yellow-100">Spec Target</th>
                                    <th className="border border-gray-400 py-1 w-14 bg-gray-700 text-white">Tol A</th>
                                    <th className="border border-gray-400 py-1 w-14 bg-gray-700 text-white">Tol B</th>
                                    <th className="border border-gray-400 py-1 w-14 bg-gray-700 text-white">Tol C</th>
                                    <th className="border border-gray-400 py-1 w-16">Section 1</th>
                                    <th className="border border-gray-400 py-1 w-16">Section 2</th>
                                    <th className="border border-gray-400 py-1 w-16">Section 3</th>
                                    <th className="border border-gray-400 py-1 w-16 bg-blue-800">Average</th>
                                    <th className="border border-gray-400 py-1 w-12 bg-blue-800">Score</th>
                                    <th className="border border-gray-400 py-1 w-12 bg-blue-800">RATING</th>
                                    <th className="border border-gray-400 py-1 w-20 bg-blue-800">STATUS</th>
                                </tr>
                            </thead>
                            <tbody className="text-center font-medium text-gray-800">
                                {cutAnalysisData.map(row => {
                                    let rowClass = "hover:bg-gray-50";
                                    let targetClass = "bg-orange-100";
                                    let statusClass = "bg-purple-500 text-white font-bold text-[9px]";
                                    
                                    const isHighlighted = highlightParam && row.parameter === highlightParam;
                                    if (row.status === 'ACTION!') { rowClass = "bg-white"; statusClass = "bg-red-600 text-white font-bold text-[9px]"; } else if (row.parameter.includes('*')) { rowClass = "bg-yellow-50"; }
                                    if (row.avg === '#DIV/0!') { rowClass = "bg-yellow-50"; }
                                    if (isHighlighted) { rowClass = "bg-blue-100 border-2 border-blue-500"; }

                                    return (
                                        <tr key={row.id} className={rowClass}>
                                            <td className="border border-gray-300 py-0.5">{row.id}</td>
                                            <td className={`border border-gray-300 px-2 text-left ${row.parameter.includes('*') ? 'font-bold' : ''}`}>{row.parameter}</td>
                                            <td className={`border border-gray-300 ${targetClass}`}>{row.specTarget}</td>
                                            <td className="border border-gray-300 px-1">{row.tolA}</td>
                                            <td className="border border-gray-300 px-1">{row.tolB}</td>
                                            <td className="border border-gray-300 px-1">{row.tolC}</td>
                                            <td className={`border border-gray-300 ${row.s1 === '3.09' ? 'text-red-600 font-bold bg-red-50' : ''}`}>{row.s1}</td>
                                            <td className="border border-gray-300">{row.s2}</td>
                                            <td className="border border-gray-300">{row.s3}</td>
                                            <td className="border border-gray-300 bg-blue-50">{row.avg}</td>
                                            <td className="border border-gray-300 bg-blue-50">{row.score}</td>
                                            <td className="border border-gray-300 bg-blue-50 font-bold">{row.rating}</td>
                                            <td className={`border border-gray-300 ${statusClass}`}>{row.status}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                        <div className="grid grid-cols-12 border-x border-b border-gray-400 bg-blue-800 text-white text-center font-semibold">
                            <div className="col-span-3 border-r border-gray-400 grid grid-rows-3 text-left">
                                <div className="border-b border-gray-400 px-2 py-0.5">Checked By <span className="float-right font-normal">Piyush Tiwari</span></div>
                                <div className="border-b border-gray-400 px-2 py-0.5">Verified By <span className="float-right font-normal">Neeraj Saxena</span></div>
                                <div className="px-2 py-0.5 bg-blue-900">Tire Disposition <span className="float-right font-bold text-yellow-300">RELEASE</span></div>
                            </div>
                            <div className="col-span-9 bg-blue-900 flex items-center justify-center p-2 text-xs"></div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const RecipewiseAnalysis = () => {
            return (
                <div className="flex-1 flex flex-col gap-2 p-2 min-h-0 bg-slate-100 h-full">
                    <div className="h-[40%] min-h-0"><CurrentMonthSection /></div>
                    <div className="h-[60%] min-h-0"><HistoricalSection /></div>
                </div>
            );
        };

        const PA_Section1 = ({ data, selectedGrade, onGradeChange, activeComponent, activeRecipe, onComponentSelect, onRecipeSelect }) => {
            const compChartRef = useRef(null);
            const recipeChartRef = useRef(null);
            const compInstance = useRef(null);
            const recipeInstance = useRef(null);
            
            // Calculate Component Counts
            const compData = useMemo(() => {
                const counts = {};
                PA_COMPONENTS.forEach(c => counts[c] = 0);
                data.forEach(d => {
                    if (d.grade === selectedGrade) counts[d.component]++;
                });
                return counts;
            }, [data, selectedGrade]);

            // Calculate Recipe Counts
            const recipeData = useMemo(() => {
                const counts = {};
                data.forEach(d => {
                    if (d.grade === selectedGrade && d.component === activeComponent) {
                        counts[d.recipe] = (counts[d.recipe] || 0) + 1;
                    }
                });
                return counts;
            }, [data, selectedGrade, activeComponent]);

            // Chart 1: Components
            useEffect(() => {
                if (!compChartRef.current) return;
                if (compInstance.current) compInstance.current.destroy();

                const ctx = compChartRef.current.getContext('2d');
                compInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: PA_COMPONENTS,
                        datasets: [{
                            data: PA_COMPONENTS.map(c => compData[c]),
                            backgroundColor: PA_COMPONENTS.map(c => c === activeComponent ? '#2563eb' : '#cbd5e1'),
                            borderRadius: 4, barThickness: 'flex', maxBarThickness: 30
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { ticks: { font: { size: 10 } } }, y: { beginAtZero: true, ticks: { display: false } , grid: { display: false } } },
                        onClick: (e, el) => { if (el.length) onComponentSelect(PA_COMPONENTS[el[0].index]); }
                    }
                });
            }, [compData, activeComponent]);

            // Chart 2: Recipes
            useEffect(() => {
                if (!recipeChartRef.current) return;
                if (recipeInstance.current) recipeInstance.current.destroy();
                
                const labels = Object.keys(recipeData);
                const ctx = recipeChartRef.current.getContext('2d');
                recipeInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: labels.map(l => recipeData[l]),
                            backgroundColor: labels.map(l => l === activeRecipe ? '#d97706' : '#94a3b8'),
                            borderRadius: 4, barThickness: 15
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { ticks: { font: { size: 9 }, autoSkip: false } , grid: { display: false } } },
                        onClick: (e, el) => { if (el.length) onRecipeSelect(labels[el[0].index]); }
                    }
                });
            }, [recipeData, activeRecipe]);

            return (
                <div className="flex h-full gap-4">
                    <div className="w-1/2 dashboard-section">
                        <div className="section-header">
                            <span className="section-title">Component Distribution</span>
                            {/* Grade Selector moved here */}
                            <div className="flex items-center gap-1 bg-gray-100 p-0.5 rounded">
                                <span className="text-[10px] font-bold text-gray-500 px-1">Grade:</span>
                                {['A', 'B', 'C', 'D'].map(g => (
                                    <button key={g} onClick={() => onGradeChange(g)}
                                        className={`w-5 h-5 rounded flex items-center justify-center text-[10px] font-bold transition-all ${selectedGrade === g ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-500 hover:bg-gray-200'}`}>
                                        {g}
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="chart-wrapper"><canvas ref={compChartRef}></canvas></div>
                    </div>
                    <div className="w-1/2 dashboard-section">
                        <div className="section-header"><span className="section-title">Recipe Impact: {activeComponent}</span></div>
                        <div className="chart-wrapper">
                            {Object.keys(recipeData).length > 0 ? <canvas ref={recipeChartRef}></canvas> : 
                            <div className="flex items-center justify-center h-full text-xs text-gray-400">No data for selected component</div>}
                        </div>
                    </div>
                </div>
            );
        };

        const PA_Section2 = ({ data, activeComponent, activeRecipe, activeParameter, onParameterSelect, availableMonths }) => {
            const [localMonth, setLocalMonth] = useState('All');

            // Helper to format YYYY-MM to MM-YY
            const formatMonth = (m) => {
                if (!m || m === 'All') return 'All';
                const [y, mon] = m.split('-');
                return `${mon}-${y.slice(2)}`;
            };

            const tableRows = useMemo(() => {
                if (!activeComponent || !activeRecipe) return [];
                const grouped = {};
                
                data.forEach(d => {
                    if (d.component === activeComponent && d.recipe === activeRecipe) {
                        // Filter by month if selected
                        if (localMonth !== 'All' && d.month !== localMonth) return;
                        
                        // Group by Parameter AND Month to preserve granularity
                        const k = `${d.parameter}|${d.month}`;
                        
                        if (!grouped[k]) {
                            grouped[k] = { 
                                param: d.parameter, 
                                month: d.month, 
                                target: d.target, 
                                total: 0, 
                                count: 0 
                            };
                        }
                        grouped[k].total += d.actual;
                        grouped[k].count++;
                    }
                });

                return Object.values(grouped).map(g => ({
                    ...g, 
                    avg: g.total / g.count, 
                    dev: Math.abs((g.total/g.count) - g.target)
                })).sort((a,b) => b.dev - a.dev); // Sort by highest deviation first
            }, [data, activeComponent, activeRecipe, localMonth]);

            return (
                <div className="dashboard-section h-full">
                    <div className="section-header">
                        <span className="section-title flex items-center gap-2">
                            Parameter Deviation Analysis
                            <span className="bg-blue-100 text-blue-700 px-2 rounded text-[10px] normal-case">{activeRecipe}</span>
                        </span>
                        <div className="flex items-center gap-2">
                            <span className="text-[10px] font-bold text-gray-500">Month Filter:</span>
                            <select value={localMonth} onChange={e => setLocalMonth(e.target.value)} className="text-xs border rounded px-1 py-0.5 bg-white">
                                <option value="All">All Months</option>
                                {availableMonths.map(m => <option key={m} value={m}>{m}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="flex-1 overflow-auto bg-white">
                        <table className="w-full text-xs text-left border-collapse">
                            <thead className="bg-gray-50 text-gray-600 font-semibold sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th className="px-4 py-2 border-b">Parameter Name</th>
                                    <th className="px-4 py-2 border-b text-center">MM-YY</th>
                                    <th className="px-4 py-2 border-b text-right">Target</th>
                                    <th className="px-4 py-2 border-b text-right">Actual Avg</th>
                                    <th className="px-4 py-2 border-b text-right">Deviation</th>
                                    <th className="px-4 py-2 border-b text-center">Trend</th>
                                </tr>
                            </thead>
                            <tbody>
                                {tableRows.map((r, i) => (
                                    <tr key={`${r.param}-${r.month}`} onClick={() => onParameterSelect(r.param)}
                                        className={`cursor-pointer border-b hover:bg-gray-50 ${activeParameter === r.param ? 'bg-blue-50' : ''}`}>
                                        <td className="px-4 py-1.5 font-medium text-gray-700">{r.param}</td>
                                        <td className="px-4 py-1.5 text-center text-gray-500">{formatMonth(r.month)}</td>
                                        <td className="px-4 py-1.5 text-right text-gray-500">{r.target.toFixed(2)}</td>
                                        <td className="px-4 py-1.5 text-right text-gray-600">{r.avg.toFixed(2)}</td>
                                        <td className={`px-4 py-1.5 text-right font-bold ${r.dev > 0.5 ? 'text-red-600' : 'text-green-600'}`}>{r.dev.toFixed(3)}</td>
                                        <td className="px-4 py-1.5 text-center text-[10px] text-blue-500">{activeParameter === r.param ? 'â— VIEWING' : 'Select'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const PA_Section3 = ({ data, activeRecipe, activeComponent, activeParameter }) => {
            const chartRef = useRef(null);
            const inst = useRef(null);
            const [tol, setTol] = useState('Tol A');

            const chartData = useMemo(() => {
                if (!activeParameter) return [];
                return data.filter(d => 
                    d.recipe === activeRecipe && d.component === activeComponent && d.parameter === activeParameter
                ).sort((a,b) => new Date(a.date) - new Date(b.date));
            }, [data, activeRecipe, activeComponent, activeParameter]);

            useEffect(() => {
                if (!chartRef.current || chartData.length === 0) return;
                if (inst.current) inst.current.destroy();

                const target = chartData[0].target;
                const margin = tol === 'Tol A' ? chartData[0].tolA : tol === 'Tol B' ? chartData[0].tolB : chartData[0].tolC;
                const upper = target + margin;
                const lower = target - margin;

                inst.current = new Chart(chartRef.current.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: chartData.map(d => d.date.slice(5)),
                        datasets: [
                            { label: 'Actual', data: chartData.map(d => d.actual), borderColor: '#2563eb', borderWidth: 1.5, pointRadius: 2, tension: 0.1 },
                            { label: 'Target', data: Array(chartData.length).fill(target), borderColor: '#16a34a', borderWidth: 1, borderDash: [5,5], pointRadius: 0 },
                            { label: 'Upper', data: Array(chartData.length).fill(upper), borderColor: '#dc2626', borderWidth: 1, borderDash: [2,2], pointRadius: 0, fill: false },
                            { label: 'Lower', data: Array(chartData.length).fill(lower), borderColor: '#dc2626', borderWidth: 1, borderDash: [2,2], pointRadius: 0, fill: false }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { labels: { boxWidth: 10, font: { size: 10 } } }, title: { display: false } },
                        scales: { y: { title: { display: true, text: 'Value (mm)' } }, x: { ticks: { maxTicksLimit: 15 } } }
                    }
                });
            }, [chartData, tol]);

            return (
                <div className="dashboard-section h-full">
                    <div className="section-header">
                        <span className="section-title flex items-center gap-2">
                            SPC Trend Analysis
                            <span className="bg-purple-100 text-purple-700 px-2 rounded text-[10px] normal-case">{activeParameter || 'No Parameter'}</span>
                        </span>
                        <div className="flex bg-gray-100 rounded p-0.5">
                            {['Tol A', 'Tol B', 'Tol C'].map(t => (
                                <button key={t} onClick={() => setTol(t)} 
                                    className={`px-2 py-0.5 text-[10px] font-bold rounded ${tol === t ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>{t}</button>
                            ))}
                        </div>
                    </div>
                    <div className="chart-wrapper">
                        {chartData.length > 0 ? <canvas ref={chartRef}></canvas> : 
                        <div className="flex items-center justify-center h-full text-xs text-gray-400">Select a parameter above to view trend</div>}
                    </div>
                </div>
            );
        };

        const ParameterwiseAnalysis = ({ fromMonth, toMonth }) => {
            // New state logic ported from the standalone App component
            const [grade, setGrade] = useState('A');
            const [component, setComponent] = useState('Tread');
            const [recipe, setRecipe] = useState(null);
            const [param, setParam] = useState(null);

            // Filter Global Data based on props
            const filteredData = useMemo(() => {
                return PA_FULL_DATABASE.filter(d => d.month >= fromMonth && d.month <= toMonth);
            }, [fromMonth, toMonth]);

            // Auto-Select Logic
            useEffect(() => {
                const validRecipes = [...new Set(filteredData
                    .filter(d => d.grade === grade && d.component === component)
                    .map(d => d.recipe))];
                
                let nextRecipe = recipe;
                if (!validRecipes.includes(recipe)) {
                    nextRecipe = validRecipes[0] || null;
                    setRecipe(nextRecipe);
                }

                if (nextRecipe) {
                    const validParams = [...new Set(filteredData
                        .filter(d => d.recipe === nextRecipe && d.component === component)
                        .map(d => d.parameter))];
                    
                    if (!validParams.includes(param)) {
                        setParam(validParams[0] || null);
                    }
                } else {
                    setParam(null);
                }
            }, [filteredData, grade, component, recipe]); 

            const months = useMemo(() => [...new Set(filteredData.map(d => d.month))].sort(), [filteredData]);

            return (
                <div className="flex flex-col h-full bg-slate-50 p-2 gap-3 overflow-hidden rounded-lg">
                    {/* ROW 1: GRAPHS (35% Height) */}
                    <div className="h-[35%] flex-shrink-0">
                        <PA_Section1 
                            data={filteredData} 
                            selectedGrade={grade} 
                            onGradeChange={setGrade}
                            activeComponent={component}
                            activeRecipe={recipe}
                            onComponentSelect={setComponent}
                            onRecipeSelect={setRecipe}
                        />
                    </div>

                    {/* ROW 2: TABLE (30% Height) */}
                    <div className="h-[30%] flex-shrink-0">
                        <PA_Section2 
                            data={filteredData}
                            activeComponent={component}
                            activeRecipe={recipe}
                            activeParameter={param}
                            onParameterSelect={setParam}
                            availableMonths={months}
                        />
                    </div>

                    {/* ROW 3: SPC TREND (35% Height) */}
                    <div className="h-[35%] flex-shrink-0 pb-1">
                        <PA_Section3 
                            data={filteredData}
                            activeComponent={component}
                            activeRecipe={recipe}
                            activeParameter={param}
                        />
                    </div>
                </div>
            );
        };

        const SSOSSAnalysis = ({ monthYear }) => {
            const [param, setParam] = useState(PARAMETERS[0]); // Default param
            const [recipe, setRecipe] = useState(RECIPES_DATA[0].name); // Default recipe
            const [loaded, setLoaded] = useState(true); // Auto-load default
            const chartRef = React.useRef(null);
            
            // Data for Chart and Table
            const ssActuals = [15.2, 15.4, 15.6, 15.8, 15.5, 15.7];
            const ossActuals = [15.1, 15.3, 15.5, 15.4, 15.6, 15.8];
            const target = 15.5;

            useEffect(() => {
                if (loaded && chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    // Mock data
                    const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                { label: 'Target', data: Array(6).fill(target), borderColor: 'gray', borderDash: [5, 5], borderWidth: 2, pointRadius: 0 },
                                { label: 'SS Actual', data: ssActuals, borderColor: '#2563eb', tension: 0.1 },
                                { label: 'OSS Actual', data: ossActuals, borderColor: '#f59e0b', tension: 0.1 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false } }
                    });
                }
            }, [loaded]);

            const canLoad = param && recipe;

            return (
                <div className="flex flex-col h-full bg-gray-50">
                    <div className="bg-white border-b border-gray-200 p-4 flex flex-wrap gap-4 items-end shadow-sm">
                        <div><label className="block text-xs font-bold text-gray-500 mb-1">Parameter</label>
                        <select className="p-2 border rounded w-64 text-sm" value={param} onChange={e=>setParam(e.target.value)}><option value="">Select Parameter</option>{PARAMETERS.map(p=><option key={p} value={p}>{p}</option>)}</select></div>
                        <div><label className="block text-xs font-bold text-gray-500 mb-1">Recipe</label>
                        <select className="p-2 border rounded w-64 text-sm" value={recipe} onChange={e=>setRecipe(e.target.value)}><option value="">Select Recipe</option>{RECIPES_DATA.map(r=><option key={r.id} value={r.name}>{r.name}</option>)}</select></div>
                        <button disabled={!canLoad} onClick={()=>setLoaded(true)} className="px-6 py-2 bg-blue-600 text-white rounded font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">Load Graph</button>
                    </div>
                    
                    {!loaded ? (
                        <div className="flex-1 flex flex-col items-center justify-center text-gray-400">
                            <TableIcon className="w-16 h-16 mb-4 opacity-20" />
                            <p>Select all criteria and click Load Graph</p>
                        </div>
                    ) : (
                        <div className="flex-1 grid grid-cols-12 gap-4 p-4 overflow-hidden">
                            <div className="col-span-8 bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex flex-col">
                                <h4 className="font-bold text-gray-800 text-xs mb-2">{param} - Trend Analysis</h4>
                                <div className="flex-1 relative"><canvas ref={chartRef}></canvas></div>
                            </div>
                            <div className="col-span-4 bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex flex-col">
                                <h4 className="font-bold text-gray-800 text-xs mb-2">Monthly Summary</h4>
                                <div className="flex-1 overflow-auto">
                                    <table className="w-full text-xs text-left">
                                        <thead className="bg-gray-50 border-b">
                                            <tr>
                                                <th className="p-2">Month</th>
                                                <th className="p-2">Target</th>
                                                <th className="p-2">Act SS</th>
                                                <th className="p-2">SS Dev</th>
                                                <th className="p-2">Act OSS</th>
                                                <th className="p-2">OSS Dev</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {[0,1,2,3,4,5].map(i => {
                                                const ss = ssActuals[i];
                                                const oss = ossActuals[i];
                                                const ssDev = (ss - target).toFixed(1);
                                                const ossDev = (oss - target).toFixed(1);
                                                return (
                                                <tr key={i}>
                                                    <td className="p-2 font-medium">2025-{1+i}</td>
                                                    <td className="p-2">{target}</td>
                                                    <td className="p-2 font-semibold text-blue-600">{ss}</td>
                                                    <td className={`p-2 font-bold ${parseFloat(ssDev) > 0 ? 'text-green-600' : 'text-red-600'}`}>{parseFloat(ssDev) > 0 ? '+'+ssDev : ssDev}</td>
                                                    <td className="p-2 font-semibold text-yellow-600">{oss}</td>
                                                    <td className={`p-2 font-bold ${parseFloat(ossDev) > 0 ? 'text-green-600' : 'text-red-600'}`}>{parseFloat(ossDev) > 0 ? '+'+ossDev : ossDev}</td>
                                                </tr>
                                            )})} 
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const DataComparison = () => {
            const [activeTab, setActiveTab] = useState('gradewise');
            const [fromMonth, setFromMonth] = useState('2025-01');
            const [toMonth, setToMonth] = useState('2025-09');
            const monthRangeStr = `${fromMonth} to ${toMonth}`;

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 min-h-[600px] flex flex-col h-[calc(100vh-130px)] overflow-hidden">
                    <div className="bg-gray-800 text-white p-3 flex justify-between items-center shadow-md z-20">
                        <div className="flex items-center gap-4">
                            <span className="font-bold text-lg tracking-tight">Data Comparison Analysis</span>
                            <div className="h-6 w-px bg-gray-600"></div>
                            <div className="flex items-center gap-2">
                                <CalendarIcon className="w-4 h-4 text-blue-300" />
                                <span className="text-xs text-gray-300 font-semibold">From</span>
                                <input type="month" value={fromMonth} onChange={(e) => setFromMonth(e.target.value)} 
                                       className="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1 focus:outline-none focus:border-blue-400" />
                                <span className="text-xs text-gray-300 font-semibold">To</span>
                                <input type="month" value={toMonth} onChange={(e) => setToMonth(e.target.value)} 
                                       className="bg-gray-700 border border-gray-600 text-white text-sm rounded px-2 py-1 focus:outline-none focus:border-blue-400" />
                            </div>
                        </div>
                        <div className="flex gap-1 bg-gray-700 p-1 rounded-lg">
                            {[
                                {id: 'gradewise', label: 'Recipewise Analysis'},
                                {id: 'parameterwise', label: 'Parameterwise Analysis'},
                                {id: 'ssoss', label: 'SS & OSS Analysis'}
                            ].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} 
                                        className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${activeTab === tab.id ? 'bg-blue-600 text-white shadow' : 'text-gray-300 hover:bg-gray-600'}`}>
                                    {tab.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="flex-1 overflow-hidden relative">
                        {activeTab === 'gradewise' && <RecipewiseAnalysis />}
                        {activeTab === 'parameterwise' && <ParameterwiseAnalysis fromMonth={fromMonth} toMonth={toMonth} />}
                        {activeTab === 'ssoss' && <SSOSSAnalysis monthYear={monthRangeStr} />}
                    </div>
                </div>
            );
        };

        let dataComparisonMounted = false;
        window.mountDataComparison = function() {
            if (dataComparisonMounted) return;
            const root = ReactDOM.createRoot(document.getElementById('data-comparison-root'));
            root.render(<DataComparison />);
            dataComparisonMounted = true;
        }

        // Bridge to render React Component in BTP Detail View
        const btpRootMap = new Map();
        window.renderMasterSheet = (containerId, props) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let root = btpRootMap.get(containerId);
            if (!root) {
                root = ReactDOM.createRoot(container);
                btpRootMap.set(containerId, root);
            }
            root.render(<CutAnalysis {...props} />);
        };
    </script>
</body>
</html>
